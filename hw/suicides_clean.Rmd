---
title: "Homework 4"
author: "Aleister Montfort"
date: "2/12/2019"
output: 
  html_document:
    css: style.css
    code_folding: hidden

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r libraries1, message=FALSE, include=FALSE}
library(ggplot2)
library(here)
library(zoo)
#library(lubridate)
library(dplyr)
library(ggridges)
```

```{r, include=FALSE}
rm(list = ls())
path = here("death_certificates.RData")
print(path)
data = load(path)

```

```{r, load data, include=FALSE}
here()
path = here("death_certificates.RData")
print(path)
data = load(path)
```
```{r, upload other data, include=FALSE}
#load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2015.RData")
path_gini15=here::here("/gini2015.RData")
load(path_gini15)
path_gini15=here::here("/gini2010.RData")
# load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2010.RData")
path_irs = here::here("/irs.RData")
load(path_irs)
#load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/irs.RData")
path_pop_cohort=here::here("/pop_by_cohort.RData")
load(path_pop_cohort)
# load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/pop_by_cohort.RData")
```


```{r, include=FALSE}
# library(here)
# path = here::here("irs.RData")
# file.exists(path)
# irs = load(path)
```

```{r colors, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
## Colors ####
#Source of this and the palette function: https://drsimonj.svbtle.com/creating-corporate-colour-palettes-for-ggplot2

ami_colors <- c(             # I will select these colors
  `red`        = "#ff3333", 
  `green`      = "#318333",
  `blue`       = '#2171b5',
  `light_blue`   = '#eff3ff',
  `orange`     = "#e19509",
  `light grey` = "#f7f7f7",
  `dark grey`  = "#808080",
  `peach` = "#FF8C76",
  `pink`= "#F082B3",
  `green2`= "#7ABA95",
  `green3` = "#4E7F35",
  `blue2`= "#4C64E8",
  `purple`= '#912FF7')




ami_cols <- function(...) { # And create this function to have them ready without typying the HEX Code
  cols <- c(...)
  if (is.null(cols))
    return (ami_colors)
  ami_colors[cols]
}
```

```{r palettes, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
## Palettes ####
ami_palettes <- list(
  `redish`  = ami_cols('red', 'orange'),

  `cool`  = ami_cols('blue', 'green'),
  
  `multi`  = ami_cols('red', 'orange', 'green', 'blue', 'grey', 'dark grey'),

  `grey`   = ami_cols("dark_grey"),

  `blue` = ami_cols("blue"),

  `red`  = ami_cols("red"),
  `green_orange`  = ami_cols("green", "orange"),
  `green` = ami_cols("green"),
  `orange` = ami_cols("orange")
)

ami_pal <- function(palette = "cool", reverse = FALSE, ...) {
  pal <- ami_palettes[[palette]]

  if (reverse) pal <- rev(pal)

  colorRampPalette(pal, ...)
}

scale_color_ami <- function(palette = "cool", discrete = TRUE, reverse = FALSE, ...) {

  pal <- ami_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("colour", paste0("ami_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}
scale_fill_ami <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- ami_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("ami_", palette), palette = pal, ...)
  } else {
    scale_fill_gradient2(colours = pal(256), ...)
  }
}
```

```{r themes, echo=FALSE}
theme_ami<-
  theme(
  panel.background = element_rect(fill = 'white',
                                colour = ami_cols("light grey"),
                                size = 0.3, linetype = "solid"),
  panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                colour = ami_cols("light grey")), 
  panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "dark grey")) +
  theme(plot.title = element_text(size = 14, family = "Karla", face='bold'))+
  theme(plot.subtitle = element_text(size=12, family = "Karla", face = "plain"))+
    theme(text=element_text(family="Karla"))+
     theme( axis.text.x=element_text(colour="black", family = "Karla", size = 10, face = "plain"))+
    theme (axis.text.y=element_text(colour="black", family = "Karla", size = 10, face = "plain"))+
        theme(legend.key=element_rect(fill="white", colour="white")) +
  theme(plot.caption = element_text(family="Karla", size=7)) +
  theme(text = element_text(family = "Karla")) +
  theme(line = element_line(color=ami_cols("green"))) 
  

theme_amiplots<-
 theme(plot.title = element_text(size = 16, family = "Karla", face='bold')) +
  theme(plot.subtitle = element_text(size=12, family = "Karla", face = "plain")) + 
    theme(text=element_text(family="Karla")) +
        theme(legend.key=element_rect(fill="white", colour="white")) +
  theme(plot.caption = element_text(family="Karla", size=7))  +
  theme(legend.title = element_text(face="bold")) +
  theme(legend.background = element_rect()) +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r prepare data chart 1, echo=FALSE}

## Subset the data ####
death_certificates <- subset(death_certificates, year_death>1997 & year_death!=9999)
## Estimate total monthly deaths ####
death_certificates$yearmonth <- as.yearmon(paste(death_certificates$year_death, death_certificates$month_death), "%Y %m")

death_certificates <- death_certificates%>%
    mutate(non_natural_causes = if_else(is.na(non_natural_causes), "N.A/Natural Death", non_natural_causes))

## Monthly deaths for non natural causes ####
monthly_death_national <-
  death_certificates %>% 
  group_by(yearmonth, ANIO_OCUR, non_natural_causes) %>% 
  tally()

#print.data.frame(head(monthly_death_national))
## Monthly deaths for all causes ####
TOTAL_monthly_death_national <-
  death_certificates %>% 
  group_by(yearmonth, ANIO_OCUR) %>% 
  tally()
```


```{r adding population, include=FALSE, warning=FALSE}

 ## ADD POPULATION TO OBTAIN RATES ####
# load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2015.RData")
# load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2010.RData")
# load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/irs.RData")

## Obtain monthly rates ####
## I add the population I am going to use in the denominator

monthly_death_national<-
  monthly_death_national %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))

TOTAL_monthly_death_national<-
  TOTAL_monthly_death_national %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))

mult<-100000
monthly_death_national<-monthly_death_national %>% 
                        mutate(death_rate=n/pop_divide*mult)
monthly_death_national<-monthly_death_national %>% 
                        mutate(natural= if_else((is.null(non_natural_causes) | non_natural_causes=="N.A/Natural Death"),1,0))
TOTAL_monthly_death_national<-TOTAL_monthly_death_national %>% 
                        mutate(death_rate=n/pop_divide*mult)                      
```
# Introduction 
In the last 12 years, scholars and policy makers have paid special attention to the increase in mortality in Mexico. This attention has focused on explaining the rise in homicides as a consequence of the policies implemented to fight against drug cartels. Though this is the most important policy challenge for the Mexican authorities and it is a source of regional concerns to the US and other neihghbours, other  patterns of mortality in Mexico receive much less attention. This work aims to explore other characteristics of mortality in Mexico, and has a focus on analyzing the pattern of suicides.

## 1. General Patterns of Mortality

In a recent article (https://econ.st/2WuSTSN), the British magazine "The Economist" notes that there is a global decline of suicides, mostly driven by China, India and Russia. Thee article also underlines that America is the big exception: this century, suicides rate in America has grown 18%, and if 20 years ago China's rate doubled America's, this relationship has been reversed.
A similar story can be told about suicides in Mexico. Compared to amount of attention that other mortality characteristic have received, this phenomenon has received less attention and, to our knowledge, there are no comprehensive studies in this regard that account for their characteristics, not to mention their causes. The rest of the analysis of this work focuses exclusively on suicides in Mexico.
Chart 1G shows the trend in suicides in Mexico. In the last 20 years, there has been a sharp increase in suicides events: the rate almost doubles.

We can distinguish four periods in the homicides trend. First, before 2006, there was a secular decline for at least 20 years before 2006. This was mostly explained due to a land reform, implemented during the eighties, that put an end to land-owning diputes that frequently ended with violent solutions. Second, this declining trend ended with the implementation of the so called 'war on drugs', which premise was to use the military forces to dismantle drug cartels. We observe a sharp increase in homicides rate until 2011. Between 2011 and 2015 homicides rate started to show a decreasing trend; though the causes have not been clearly explained, some scholars attribute it to a more effective use of force; the dismantling of the "Zetas", the most violent cartel at the moment, and the momentary prevalence of a single powerful cartel (The Sinaloa Cartel). Then, after 2015, the rate increased again. Again, though there is no a consensus that explain this renewed upward trend, some argue that the inaction of former President Pena Nieto's government to face this problem, jointly with a persistent fragmentation of cartels, allowed these organizations to reorganize and dispute territories and rents against other cartels.
This sub-group corresponds to non-natural causes of death that were not classified. Interestingly, these deaths follow a similar pattern as the homicides' one: a relative decline up to the mid-2000's; then an increase between 2010 and 2012, followed by a decrease up to around 2015. After this, an upward trend is observed. This suggest that, perhaps, most of these deaths may correspond to homicides but administrative deficiencies prevented them to be correctly classified.

```{r, echo=FALSE, message=FALSE}
monthly_death_national<-monthly_death_national %>% 
                        mutate(log_rate= log(death_rate))

death_filtered <- deaths_base100 %>%
  filter(non_natural_causes=="Suicide") 
war_operations_df <- monthly_death_national %>%
  filter(non_natural_causes=="War Operations")
homicides_df <- deaths_base100 %>%
  filter(non_natural_causes=="Homicide") 
accidents_df <- deaths_base100 %>%
  filter(non_natural_causes=="Accident") 
dn_df <- deaths_base100 %>%
  filter(non_natural_causes=="Don't know") 


deaths_base100<-monthly_death_national %>% 
  mutate(index = case_when(non_natural_causes=="Accident" ~ (death_rate*100/4.10),  
                           non_natural_causes=="Homicide" ~ (death_rate*100/1.09),
                           non_natural_causes=="Don't know" ~ (death_rate*100/.26),
                           non_natural_causes=="Suicide" ~ (death_rate*100/.286),
                           non_natural_causes=="N.A/Natural Death" ~ (death_rate*100/29.8),
                         non_natural_causes=="War Operations" ~ (death_rate*100/0.00103)))

non_natural_plot<-ggplot() + 
geom_line(aes(x=yearmonth, y=index, group = non_natural_causes), data = subset(deaths_base100, non_natural_causes!="War Operations"), colour = alpha("grey", 0.4), size=.4) +
  geom_line(aes(x=yearmonth, y=index), data = death_filtered, colour = ami_cols("green2"), alpha=.9, size=.6) +
  geom_line(aes(x=yearmonth, y=index), data = homicides_df, color=ami_cols("blue"),alpha=.6, size=.2) +
 scale_x_discrete(limit = c(1998, 2003, 2008, 2013,  2018)) +
  annotate("label", x = 2008.5, y = 178.2, label = "Homicides", color=ami_cols("blue"), family="Karla", size=4, alpha=.6) +
  annotate("label", x = 2015.6, y = 184.5, label = "Suicides", color=ami_cols("green2"), family="Karla", size=4) +
  annotate("segment", x = 2009.53, xend = 2009.85, y = 178.2, yend = 178.2,
  colour = ami_cols("blue"))+
  annotate("segment", x = 2014.6, xend = 2014.8, y = 178, yend = 181,
  colour = ami_cols("green2"))+
      labs(title = "Change in Death Rate for Different Causes Deaths in Mexico",
       subtitle = "Suicide rate has grown more than 50% since 1998 (January 1998=100)",
       caption = "Source: INEGI and CONAPO", 
       x = "Year", y = "Index (January 1998=100)")+
    geom_vline(xintercept =2006.917 , linetype="dotted", 
                color = ami_cols("blue"), size=.7)+ ylim(40, 215) +
  geom_text(aes(x=2006.8, label="War on drugs starts", y=40, family="Karla"), size=4, color=ami_cols("blue"), hjust=1) +
  theme_ami

# `peach` = "FF8C76",
#   `pink`= "F082B3",
#   `green2`= "7ABA95",
#   `blue2`= "4C64E8",
#   `purple`= '912FF7')

```





```{r testing fonts, include=FALSE}
p1 = ggplot(NULL, aes(x = 1, y = 1)) + ylim(0.8, 1.2) +
    annotate("text", 1, 1.0, label = "Karla es esta que obno",
             family = "Karla", size = 5) +
    annotate("text", 1, 1.1, label = "NanumGothic",
             family = "NanumGothic", size = 5) +
    annotate("text", 1, 1.05, label = "MerriweatherSans-BoldItalic",
             family = "MerriweatherSans-BoldItalic", size = 5) +    
    annotate("text", 1, 1.3, label = "HindSiliguri-Regular",
             family = "HindSiliguri-Regular", size = 5) +     
    annotate("text", 1, .94, label = "Dosis-Regular",
             family = "Dosis-Regular", size = 5) +
    annotate("text", 1, .90, label = "Assistant-Regular",
             family = "Assistant-Regular", size = 5) +
    annotate("text", 1, .86, label = "Arvo",
             family = "Arvo", size = 5) +
    annotate("text", 1, .82, label = "Wingdings-Regular",
             family = "Wingdings-Regular", size = 5) +
  theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          axis.text  = element_blank())

p2 = ggplot(NULL, aes(x = 1, y = 1)) + ylim(0.8, 1.2) +
    annotate("text", 1, 1.15, label = "Advent Pro",
             family = "Advent Pro", size = 5) +
    annotate("text", 1, 1.1, label = "IBM Plex Mono" ,
             family = "IBM Plex Mono" , size = 5) +
    annotate("text", 1, 1.05, label = "Economica",
             family = "Economica", size = 5) +    
    annotate("text", 1, 1, label = "Alegreya Sans",
             family = "Alegreya Sans", size = 5) +     
    annotate("text", 1, .94, label = "Cabin Condensed",
             family = "Cabin Condensed", size = 5) +
    annotate("text", 1, .90, label = "Hind Guntur",
             family = "Hind Guntur", size = 5) +
    annotate("text", 1, .86, label = "Domine"  ,
             family = "Domine"  , size = 5) +
    annotate("text", 1, .82, label = "Advent Pro Medium",
             family = "Advent Pro Medium", size = 5) +
  theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          axis.text  = element_blank())
# font_import(paths = here("fonts (1)")) 
#loadfonts() advent pro economica o karla ("Advent Pro", "IBM Plex Mono", "Economica", "Alegreya Sans", "Cabin Condensed", "Hind Guntur", "Domine")
```




## 2. Suicides in Mexico

To create this chart, I re-grouped the classification coming in the databases (which use the [International Classification of Diseases](https://www.who.int/classifications/icd/en/)) into 13 categories, and then I wanted to show which causes of death are more prevalent along age ([I got inspired from Nathan Yau's chart](https://flowingdata.com/2016/01/05/causes-of-death/)). The chart only shows the cause of death for males. As expected, some causes of death are more prevalent for young than for old people and viceversa. For instance, suicides affect mostly younf people; and as you get older, the chances of dying by a respiratory system related cause increases. 

```{r suicide_by_occupation and ange, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
suicides_occupation<- death_certificates %>% select(non_natural_causes,sex,school_category, occupation, age_years)

suicides_occupation_male <- filter(suicides_occupation, non_natural_causes=="Suicide" & sex=="Male" & age_years>=25 & age_years<=50)

suicides_occupation_male = suicides_occupation_male %>% 
                              mutate(occupation =                                        if_else(occupation=='55',"Industrial/Manufacturing/Transport worker", occupation))
suicides_occupation_male = suicides_occupation_male %>% 
                              mutate(occupation =                                        if_else(occupation=="Looking for Job" | occupation=='Not Working',"Not Working/Looking for a job", occupation))

suicides_occupation_male = suicides_occupation_male %>% 
                              mutate(occupation =                                        if_else(occupation=="Informal seller (Vend. Amb)"| occupation=="Domestic/House Services","Informal Worker", occupation))

normalized_suic_age_male<- suicides_occupation_male %>% 
  group_by(age_years, occupation) %>% 
  tally() %>% 
group_by(age_years) %>% mutate(percent = n/sum(n)*100)

normalized_suic_age_male$ordered_vars <- factor(normalized_suic_age_male$occupation, levels=c("NA", "Not Working/Looking for a job", "Artisan/Auxiliary Workers", "Primary Sector Worker", "Surveillance-Personal Services", "Informal Worker", "Industrial/Manufacturing/Transport worker", "Admin Work", "Salesman", "White Collar", "Professional-Technical worker", "Personal Services at businesses" ))

size_parameter<-2.5
occupation_plot<-ggplot(normalized_suic_age_male, aes(x=age_years, y=percent, fill=ordered_vars)) +  
  geom_area(size=.05, alpha=.7, color='black' , show.legend = FALSE) +
scale_fill_manual(values=ami_pal("multi")(12)) +
    geom_text(aes(x=47, label="No information", y=95), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Not working/Looking for a Job", y=78), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Artisan/Auxiliary Workers", y=67), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Primary Sector", y=55), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Surveillance/Personal Services", y=45), colour="white", size=size_parameter) +
    geom_text(aes(x=28, label="Peddlers/Domestic Work", y=40), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Industrial/Manufacturing/\nTransport", y=28), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Administrative", y=17), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Sales", y=10), colour="white", size=size_parameter) +
    geom_text(aes(x=48, label="White Collar", y=6), colour="white", size=size_parameter) +
    geom_text(aes(x=43, label="Professional/Technical", y=3.5), colour="white", size=size_parameter) +
    geom_text(aes(x=28, label="Personal Services", y=1.75), colour="white", size=size_parameter) +
  labs(title = "2. Suicide Cases by Ocupation and Age",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Age", y = "%") +
       theme(plot.title = element_text(lineheight=.8, face="bold")) +
theme_ami
occupation_plot
```



### B. Male and Female Suicides

What are the some of the characteristics of suicides in Mexico? The chart below analyzes the distribution of ages across males and females, and aims to explore if there is a change in the age composition of suicides in the last 20 years. The Economist's article emphasizes that the drop in suicides around the world is driven by three groups: young women in China and India; middle-age men in Russia and old people all around the world. Then, a pertinent question is which groups explain the rise in suicides?

The first thing to note is that suicides are more prevalent among young and males (though with these charts I do not intend to support the argument that it is more prevalent in males). The mean age for males is around 36.1 years old, and for females is 30.5 across period 1998-2017. The chart on top shows the distribution of ages for males ([this code comes from here](https://socviz.co/refineplots.html)). From this chart, it is important to notice that across the years, the curves have flattened, suggesting that suicides are becoming more prevalent in middle-age groups (i.e. the 1998 distribution was more compact and peaked than the 2017 distribution, which left tail is getting longer, concentraring its mass distribution on the right). In fact, the average age ot death for males went from  34.6 in 1998 to 36.1, and for females from 28.9 to 31.6. This flattening of the curve is also notable for females.

```{r violinsplot, echo=FALSE, warning=FALSE, message=FALSE}
library(ggridges)
suicides_by_sex<- death_certificates %>% select(non_natural_causes,sex, age_years, year_death)

suicides_by_sex <- subset(suicides_by_sex, (non_natural_causes=="Suicide") & (year_death==1998 | year_death==2008 |year_death==2017)  & sex!="Not specified") 

stat_sum_df <- function(fun, geom="crossbar", ...) {
  stat_summary(fun.data = fun, colour = "red", geom = geom, width = 0.2, ...)
}


mean_male_98<-suicides_by_sex %>% filter(sex=="Male" & year_death==1998) %>%select(age_years) %>% summarize(mean(age_years, na.rm = TRUE))
mean_male_08<-suicides_by_sex %>% filter(sex=="Male" & year_death==2008) %>%select(age_years) %>% summarize(mean(age_years, na.rm = TRUE))
mean_male_17<-suicides_by_sex %>% filter(sex=="Male" & year_death==2017) %>%select(age_years) %>% summarize(mean(age_years, na.rm = TRUE))

mean_female_98<-suicides_by_sex %>% filter(sex=="Female" & year_death==1998) %>%select(age_years) %>% summarize(mean(age_years, na.rm = TRUE))
mean_female_08<-suicides_by_sex %>% filter(sex=="Female" & year_death==2008) %>%select(age_years) %>% summarize(mean(age_years, na.rm = TRUE))
mean_female_17<-suicides_by_sex %>% filter(sex=="Female" & year_death==2017) %>%select(age_years) %>% summarize(mean(age_years, na.rm = TRUE))

dat_text1 <- data.frame(
  label = c(28.9, 30.4, 31.6),
  year_death   = c(1998, 2008, 2017),
  Sex     = c("Female", "Female", "Female"),
  age_years     = c(28.9, 30.4, 31.6)
)
dat_text2 <- data.frame(
  label = c(34.6, 36.5, 36.1),
  year_death   = c(1998, 2008, 2017),
  Sex     = c("Male", "Male", "Male"),
  age_years     = c(34.6, 36.5, 36.1)
)

colnames(suicides_by_sex)[colnames(suicides_by_sex)=="sex"] <- "Sex"

violines<-ggplot(suicides_by_sex, aes(y=age_years, x=Sex, fill=Sex), alpha=.1) +
  geom_violin(alpha=.6) +
  scale_fill_manual(values=c("#318333", "#e19509")) +
 geom_violin(draw_quantiles = c(0.25, .5, 0.75), linetype = "dashed",show.legend = FALSE, alpha=0.1)  + 
geom_violin(fill= 'transparent', alpha=0.1) +
  facet_wrap(~ year_death) +
geom_text(
  data    = dat_text1,
  mapping = aes(y = age_years, x = Sex,  label = label), size=3, family="Karla") +
geom_text(
  data    = dat_text2,
  mapping = aes(y = age_years, x = Sex,  label = label), size=3, family="Karla")+
  ggtitle("Age Distribution of Suicide Cases by Sex")+
  labs( subtitle = "(Years 1998, 2008, 2017. The number in the plot corresponds to the average age)",
      caption="Source: INEGI" ,x = "Sex", y = "Years") +
  theme_ami

violines
```


### B. Suicides and Population

The first chart below plots the annual suicide rate (cases per 100 thousand inhabitants) and municipality's population size. The data to create this chart was censored for municipalities that have more than 100,000 inhabitants, which are only a small hand of cities with low suicide rates. Then, across all municipalities, the rates of suicides are pretty similar, but after a certain size threshold (around 25 thousand inhabitants), the rate increases much more. Otherwise said, municipalities that are small in size present the largest rate of homicides.
The chart below present a similar information, but plots on the y axis the average annual change rate in suicides rate for the entire sample period (1998-2017). Again, smaller municipalities show the fastest increase in the rate of homicides.

```{r, echo=FALSE, include=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
####### SUICIDES AND POPULATION #####
# First I want to create average change in suicide rate
library(lubridate)
library(stringi)

suicides_municipal_month <-
  filter(death_certificates, non_natural_causes== 'Suicide') %>% 
  group_by(state_mun_OCUR, ANIO_OCUR) %>% 
  tally()

suicides_municipal_month %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))
pop15<-irs[,c('pop2015', 'municipal_id')]

suicides_municipal_month<- merge(x = suicides_municipal_month, y = pop15, by.x = 'state_mun_OCUR', by.y ='municipal_id' )
suicides_15<-(subset(suicides_municipal_month, suicides_municipal_month$ANIO_OCUR==2015))

suicides_15<- suicides_15 %>%
  mutate(rate_suic_15 = n/pop2015*100000)
suicides_municipal_month<-suicides_municipal_month%>%
  mutate(diff_perc_rate = (((n/pop2015)  - lag((n/pop2015)))/lag((n/pop2015))))


mean_suicide<-suicides_municipal_month  %>%
  group_by(state_mun_OCUR) %>%
  summarise_at(vars(diff_perc_rate), funs(mean(., na.rm=TRUE)))

mean_suicide <- merge(x = mean_suicide, y = irs, by.x = 'state_mun_OCUR', by.y ='municipal_id' )
mean_suicide <- merge(x = mean_suicide, y = gini2015, by.x = 'state_mun_OCUR', by.y ='id_municipal_gini' )
mean_suicide <- merge(x=mean_suicide, y = suicides_15, by.x='state_mun_OCUR', by.y = 'state_mun_OCUR')
mean_suicide<-mean_suicide  %>%
  mutate(income_ratio=as.numeric(income_ratio))
mean_suicide<-mean_suicide  %>%
  mutate(rank15=as.numeric(rank15))

suicides_rate_plot <- ggplot(subset(mean_suicide, mean_suicide$pop2015.x<100000), aes(x=pop2015.x, y=diff_perc_rate))+  # rate_suic_15
 geom_point(bins = 30, alpha=.95) + 
  
  ggtitle("3B1. Smaller and Rural Municipalities have the largest \nsuicides rates in the country")+
  labs( subtitle = "(Rate of Suicides per 100K inhabitants 2015 (NEED TO CORRECT OR DELETE))",
      caption="Source: INEGI and CONAPO,Sample limited to n\ population<100,000 and suicide rate<100", x = "Population", y = "Annual Rate (per 100k)") +
      theme_ami


scaleFUN <- function(x) sprintf("%.2f", x)

suicides_ratechange_plot <- ggplot(subset(mean_suicide, rate_suic_15>=12), aes(x=pop2015.x, y=rate_suic_15, size=pop2015.x))+ geom_jitter()+
  ggtitle("3B2. Smaller and Rural Municipalities also show the largest rate of \n growth in the last 20 years")+
  labs( subtitle = "Average rate of growth 1999-2017",
      caption="Source: INEGI and CONAPO" ,x = "Population", y = "Rate (%)") +
  #      theme(plot.title = element_text(lineheight=.8, face="bold")) +
  # scale_x_continuous(trans='log',name ="logpopulation", labels=scaleFUN) 
theme_ami

suicides_ratechange_plot
```

### C. Time and Age Patterns 

Differences across cohorts are remarkable. The suicides rate shows the largest increase among the young: for the 15-35 years old cohort, it increased from around 6 cases per 100k inhabitants, to a little bit more than 8 in 2017. This growth is also remarkable among the 35-50 cohort, which rose from around 5 to 7 cases per 100k. Among the 50-70 cohort we observe an relatively stable average (though it may seem to exist a seasonality pattern). Finally, in the elder cohort we see a continous drop in suicides (from around 7 to around 5 cases per 100k).
```{r cohort trends data, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
suicides_by_cohort<-death_certificates[which(death_certificates$non_natural_causes=="Suicide"),] 
# Let's re arrange the cohort population dataset#
library(reshape2)
pop_cohort2 <- melt(pop_by_cohort, id=c("cohort"))
colnames(pop_cohort2)[colnames(pop_cohort2)=="variable"] <- "year_merge"
colnames(pop_cohort2)[colnames(pop_cohort2)=="value"] <- "population"
colnames(pop_cohort2)[colnames(pop_cohort2)=="cohort"] <- "age_cohort"
pop_cohort2$year_merge1<-as.numeric(pop_cohort2$year_merge)
pop_cohort2<-pop_cohort2 %>% 
  mutate(year_merge1 = case_when(year_merge1==1 ~ 1995,
                                           year_merge1==2 ~ 2000,
                                           year_merge1==3 ~ 2005,
                                           year_merge1==4 ~ 2010,
                                           year_merge1==5 ~ 2015))

pop_cohort2$year_merge <- NULL
colnames(pop_cohort2)[colnames(pop_cohort2)=="year_merge1"] <- "year_merge"

suicides_by_cohort <-suicides_by_cohort %>%  mutate(age_cohort = case_when(age_years<15 ~ 'Less than 15',
                                           age_years>=15 & age_years<35 ~ '15 to 35',
                                           age_years>=35 & age_years<50 ~ '35 to 50',
                                           age_years>=50 & age_years<70 ~ '50 to 70',
                                           age_years>=70 ~ 'More than 70'))

suicides_by_cohort_total <-
  suicides_by_cohort %>% 
  group_by(age_cohort, year_death) %>% 
  tally()

suicides_by_cohort_total<-suicides_by_cohort_total %>% 
  mutate(year_merge = case_when(year_death<2000 ~ 1995,
                                           year_death>=2000 & year_death<=2004 ~ 2000,
                                           year_death>=2005 & year_death<= 2009 ~ 2005,
                                           year_death>=2010 & year_death<= 2015 ~ 2010,
                                           year_death>2015 ~ 2015))

final_suicides_by_cohort <- dplyr:: left_join(suicides_by_cohort_total, pop_cohort2,
                                              by=c("age_cohort"="age_cohort", "year_merge"="year_merge"))

final_suicides_by_cohort<-final_suicides_by_cohort  %>%
   mutate(rate_suicides_bycohort = n/population*100000)

final_suicides_by_cohort$ordered_cohort <- factor(final_suicides_by_cohort$age_cohort, levels = c("Less than 15", "15 to 35", "35 to 50", "50 to 70", "More than 70"))

```

```{r cohorts plot, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE,  results='hide'}
cohortsplot=ggplot(final_suicides_by_cohort %>% filter(!is.na(ordered_cohort) & ordered_cohort!="Less than 15"), aes(x=year_death, y=rate_suicides_bycohort, color=age_cohort)) +
  geom_step() +
  facet_wrap(~ ordered_cohort) +
  ggtitle("Suicides are ramping up among young population")+
  labs( subtitle = "Rates of suicides by age cohort",
      caption="Source: INEGI and CONAPO" ,x = "Year", y = "Rate/100K") +
  scale_color_manual(values=c("#7ABA95" ,"#7ABA95" ,"#4C64E8" ,"#4C64E8"), guide=FALSE )+
  scale_alpha_manual(values=c(0,0,0.6,0.6)) +
  theme_ami
cohortsplot

# `pink`= "#F082B3",
#   `green2`= "#7ABA95",
#   `green3` = "#4E7F35",
#   `blue2`= "#4C64E8",
#   `purple`= '#912FF7'
```


The heatmaps below analyze the temporal pattern of suicides occurence. An intervention aimed to prevent suicides should consider when suicides are more likely to occur. The heatmaps below show time patterns between male and female suicide cases. Whereas for males the likelihood of suicide occurence is greater during the weekends (the horizontal blocks for Sunday and Monday), and in any day around midnight (the vertical line on zero), these patterns do not exist in the female cases. Rather, the distribution of cases across days and times is more homogenous.[^1]

[^1]: Note that the scales are different

```{r suicide heatmap, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
## Suicide time heatmap####
library(lubridate)
library(ggpubr)
library(cowplot)
library(egg)

daily_suicides<-death_certificates[which(death_certificates$non_natural_causes=="Suicide"),] 
daily_suicides <-  daily_suicides  %>%
  mutate(day_of_suicide=weekdays(as.Date(date_death)))


daily_suicides$numeric_time<- as.POSIXct(daily_suicides$time_death, format = "%H:%M:%S")
daily_suicides$hour_suicide <- hour(daily_suicides$numeric_time)

test_suicides <-
  daily_suicides %>% 
  group_by(hour_suicide, day_of_suicide, sex) %>% 
  tally()

test_suicides$day_of_suicide <- factor(test_suicides$day_of_suicide, levels = c( "Friday","Thursday", "Wednesday", "Tuesday",  "Monday",  "Sunday", "Saturday" ))
#c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

test_suicides <- test_suicides %>%
              mutate(hour_factor=as.factor(hour_suicide))
test_suicides$hour_factor <- factor(test_suicides$hour_suicide, levels = c(  "12","13", "14","15", "16","17",'18','19','20','21','22','23','0','1','2','3','4','5','6','7','8','9','10','11'))
#c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))

## Male Plot ####
heat_map_suicide_male <- ggplot(test_suicides %>% filter(!is.na(day_of_suicide) & !is.na(hour_suicide) & sex=='Male'), aes(hour_factor, day_of_suicide,  fill=n)) +  
 geom_tile(aes(fill = n), color="white") +
      scale_fill_gradient(low = "white", high = ami_cols('blue')) + #scale_x_discrete(position = "top")+
    scale_x_discrete(position = "top", breaks=test_suicides$hour_factor, expand=c(0,0) ) +
  
  ggtitle("Time Patterns in Suicides")+
  labs( subtitle = " Male suicides occur around midnight all weekdays, and mostly during weekends, whereas female suicides \nare more evenly distributed in the weekdays",
      caption="" ,x = "Time", y="") +
  labs(fill = "# Male Suicides") +
  theme_ami +
  theme(axis.text.x=element_text(size=6.5))
  
## Female Plot ####

heat_map_suicide_female <- ggplot(test_suicides %>% filter(!is.na(day_of_suicide) & !is.na(hour_suicide) & sex=="Female"), aes(hour_factor, day_of_suicide,  fill=n)) +  
 geom_tile(aes(fill = n), color="white") +
    scale_fill_gradient2 (low = "white", high = ami_cols('green2'))  +
  # scale_fill_ami(discrete=TRUE,palette = "redish", guide = "none") +
#scale_fill_gradient2(high = "darkred") + #scale_x_discrete(position = "top")+
    scale_x_discrete(position = "top", breaks=test_suicides$hour_suicide, expand=c(0,0)) +
  
  labs( #subtitle = "Average rate of growth 1999-2017",
      caption="Source: INEGI and CONAPO" ,x = "", y="") +
  labs(fill = "# Female Suicides") +
   theme_ami +
  theme(axis.text.x=element_text(size=6.5))

heatmaps<-ggarrange(heat_map_suicide_male, heat_map_suicide_female, ncol=1)
#heatmaps
# heatmaps<-plot_grid(heat_map_suicide_male, heat_map_suicide_female, ncol=1, nrow=1, align = "hv", axis='l', rel_widths = 1, rel_heights = 1) 
# heatmaps
## HOMICIDES########
# daily_homicides<-death_certificates[which(death_certificates$non_natural_causes=="Homicide"),] 
# daily_homicides <-  daily_homicides  %>%
#   mutate(day_of_homicide=weekdays(as.Date(date_death)))
# 
# 
# daily_homicides$numeric_time<- as.POSIXct(daily_homicides$time_death, format = "%H:%M:%S")
# daily_homicides$hour_homicide <- hour(daily_homicides$numeric_time)
# 
# daily_homicides <-
#   daily_homicides %>% 
#   group_by(hour_homicide, day_of_homicide) %>% 
#   tally()
# 
# daily_homicides$day_of_homicide <- factor(daily_homicides$day_of_homicide, levels = c("Sunday",  'Saturday', 'Friday', "Thursday",  "Wednesday", "Tuesday", "Monday" ))
# 
# p_hom <- ggplot(daily_homicides %>% filter(!is.na(day_of_homicide)), aes(hour_homicide, day_of_homicide,  fill=n)) +  
#   # stat_density(aes(fill = stat(count)), geom = "raster", position = "identity") +
#   # #geom_raster() +
#   #geom_raster() 
#  #stat_density(aes(fill = stat(density)), geom = "raster", position = "identity")
#  geom_tile(aes(fill = n), color="white") +
# scale_fill_gradient2(high = "darkred") + #scale_x_discrete(position = "top")+
#     scale_x_continuous(position = "top", breaks=daily_homicides$hour_homicide) +
#   ggtitle("Homicides by weekday and time of the day")+
#   labs( #subtitle = "Average rate of growth 1999-2017",
#       caption="Source: INEGI and CONAPO" , x = "Time", y = "Day") +
#   theme(
#   panel.background = element_rect(fill = 'white',
#                                 colour = ami_cols("light grey"),
#                                 size = 0.3, linetype = "solid"),
#   panel.grid.major = element_line(size = 0.15, linetype = 'solid',
#                                 colour = ami_cols("light grey")), 
#   panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
#                                 colour = "dark grey")) +
#   theme(plot.title = element_text(size = 14, family = "Georgia-Bold"))+
#   theme(plot.subtitle = element_text(size=12, family = "Georgia", face = "plain"))+
#     theme(text=element_text(family="Georgia"))+
#      theme(  axis.text.x=element_text(colour="black", family = "Georgia", size = 7, face = "plain"))+
#     theme (axis.text.y=element_text(colour="black", family = "Georgia", size = 10, face = "plain"))+
#         theme(legend.key=element_rect(fill="white", colour="white")) +
#   theme(plot.caption = element_text(family="Georgia", size=7))


```





```{r, include=FALSE}
# theme<- theme(element_line(colour = "blue", size = 6, linetype = "solid",
#   lineend = round), rect, text, title, aspect.ratio, axis.title, axis.title.x,
#   axis.title.x.top, axis.title.x.bottom, axis.title.y, axis.title.y.left,
#   axis.title.y.right, axis.text, axis.text.x, axis.text.x.top,
#   axis.text.x.bottom, axis.text.y, axis.text.y.left, axis.text.y.right,
#   axis.ticks, axis.ticks.x, axis.ticks.x.top, axis.ticks.x.bottom,
#   axis.ticks.y, axis.ticks.y.left, axis.ticks.y.right, axis.ticks.length,
#   axis.line, axis.line.x, axis.line.x.top, axis.line.x.bottom, axis.line.y,
#   axis.line.y.left, axis.line.y.right, legend.background, legend.margin,
#   legend.spacing, legend.spacing.x, legend.spacing.y, legend.key,
#   legend.key.size, legend.key.height, legend.key.width, legend.text,
#   legend.text.align, legend.title, legend.title.align, legend.position,
#   legend.direction, legend.justification, legend.box, legend.box.just,
#   legend.box.margin, legend.box.background, legend.box.spacing,
#   panel.background, panel.border, panel.spacing, panel.spacing.x,
#   panel.spacing.y, panel.grid, panel.grid.major, panel.grid.minor,
#   panel.grid.major.x, panel.grid.major.y, panel.grid.minor.x,
#   panel.grid.minor.y, panel.ontop, plot.background, plot.title,
#   plot.subtitle, plot.caption, plot.tag, plot.tag.position, plot.margin,
#   strip.background, strip.background.x, strip.background.y,
#   strip.placement, strip.text, strip.text.x, strip.text.y,
#   strip.switch.pad.grid, strip.switch.pad.wrap, ..., complete = FALSE,
#   validate = TRUE)

```

```{r load data for maps, echo=FALSE, warning=FALSE, include=FALSE, results='hide', message=FALSE}
# install.packages(c("cowplot", "googleway", "ggrepel", 
# "ggspatial", "libwgeom", "sf", "rnaturalearth", "rnaturalearthdata", "rgeos"))
#load(here("Data/diego_valle/mxmunicipio.map.RData"))
# scale_colour_gradient2(low=ami_cols("green"), high=ami_cols("orange"),
   #                      na.value = ami_cols("dark grey") 
   #                       ) +
  #scale_fill_gradient(name = 'Rate(#/100k)',low = ami_cols("green"), high = ami_cols('orange')) +
  #scale_colour_gradientn(colors=ami_pal("cool")(4)) +
  #scale_fill_brewer( color=ami_cols("green"), name = "Rate (#/100K)" )+
load(here::here("Data/diego_valle/df_mxstate.RData"))

```

```{r maps, echo=FALSE,message=FALSE, echo=FALSE, results='hide',warning=FALSE}
library('rgdal')
library("sf")
library("mxmaps")
library("viridis")
library("scales")

k<-100000


## Age States Suicides ####
state_shape<- st_read(here::here("data/state_boundaries/dest_2015gw/dest_2015gw.shp"))
state_shape<-st_simplify(state_shape)

suicides_state_yearly <-
  filter(death_certificates, non_natural_causes== 'Suicide') %>% 
  group_by(state_ocur, ANIO_OCUR) %>% 
  tally()

state_population<- irs %>%
  group_by(cve_edo) %>%
  summarize(tot00 = sum(pop2000, na.rm = TRUE),
            tot05 = sum(pop2005, na.rm = TRUE),
            tot10=sum(pop2010, na.rm=TRUE),
            tot15=sum(pop2015, na.rm=TRUE))

## Have to do this because there is no single ID (as compared to municipal data)
suicides_state_yearly<-suicides_state_yearly %>% 
  mutate(year_merge = case_when(ANIO_OCUR<2000 ~ "tot00",
                                           ANIO_OCUR>=2000 & ANIO_OCUR<=2004 ~ "tot00",
                                           ANIO_OCUR>=2005 & ANIO_OCUR<= 2009 ~ "tot05",
                                           ANIO_OCUR>=2010 & ANIO_OCUR<= 2015 ~ "tot10",
                                           ANIO_OCUR>2015 ~ "tot15"))

state_population<-melt(state_population, id=c("cve_edo"))

##THIS IS ONLY FOR AGE PLOTS####
suicides_state_age_by_sex<-
  filter(death_certificates, non_natural_causes== 'Suicide' & (sex=="Male" | sex=="Female")) %>% 
  group_by(state_ocur, sex) %>% 
  dplyr::summarize(Mean = mean(age_years, na.rm=TRUE))

male_state_suicides<-dplyr:: left_join(state_shape, subset(suicides_state_age_by_sex,sex=="Male"),  by= c('CVE_ENT'="state_ocur"))

female_state_suicides<-dplyr:: left_join(state_shape, subset(suicides_state_age_by_sex,sex=="Female"), by= c( 'CVE_ENT'="state_ocur"))

male_state_suicides$value<-cut(male_state_suicides$Mean, 4, labels=c("22 to 27", "28 to 32" , "32 to 36", "37 to 41"))
colnames(male_state_suicides)[colnames(male_state_suicides)=="CVE_ENT"] <- "region"

female_state_suicides$value<-cut(female_state_suicides$Mean, 4, labels=c("27 to 29", "30 to 31" , "32 to 33", "33 to 35"))
colnames(female_state_suicides)[colnames(female_state_suicides)=="CVE_ENT"] <- "region"



male_state_suicide_plot<- mxhexbin_choropleth(male_state_suicides, num_colors = 4) +
 labs(title = "Average Age of Male Suicide Cases 1998-2017",
       subtitle = "",
      legend = "Age",
       caption = "Source: INEGI, CONAPO and Diego Valle's Blog for the hexaplot  (https://www.diegovalle.net)") + scale_fill_brewer(palette=ami_pal("green")(4), direction=-1) +
theme_amiplots

female_state_suicide_plot<- mxhexbin_choropleth(female_state_suicides, num_colors = 4) +
 labs(title = "Average Age of Female Suicide Cases 1998-2017",
       subtitle = "",
      legend = "Age",
       caption = "Source: INEGI, CONAPO and Diego Valle's Blog for the hexaplot  (https://www.diegovalle.net)") + scale_fill_brewer(palette='OrRd', direction=-1) +
theme_amiplots 


suicides_state_yearly <- dplyr:: left_join(suicides_state_yearly, state_population,by=c("state_ocur"="cve_edo", "year_merge"="variable"))
#rm(death_certificates)
suicides_state_yearly<-suicides_state_yearly %>% 
  mutate(rate = n/value*k)
state_average_suicide<-suicides_state_yearly%>%
  group_by(state_ocur) %>%
  summarise_at(vars(rate), funs(mean(., na.rm=TRUE)))
state_average_suicide<-state_average_suicide[which(state_average_suicide$state_ocur!= 99 & state_average_suicide$state_ocur!=33 & state_average_suicide$state_ocur!=35),]

## PLOT THE HEXBINS ####
# df_mx_state<- select (df_mxstate, c(region, state_name, state_name_official, state_abbr,pop))
# df_mx_state<-merge(x=df_mx_state, y=state_average_suicide, by.x='region', by.y="state_ocur")

colnames(df_mx_state)[colnames(df_mx_state)=="rate"] <- "value"



# state_suicide_rate_plot<- mxhexbin_choropleth(df_mx_state, num_colors = 1) +
#   scale_fill_gradient("Rate",low=ami_cols("green"), high = ami_cols("orange")) +
#    labs(title = "Average Suicide Rate 1998-2017",
#        subtitle = "Southeastern states show the higher suicide rates",
#        caption = "Source: INEGI, CONAPO and Diego Valle's Blog for the hexaplot  (https://www.diegovalle.net)") +
#   
#   
#  theme(plot.title = element_text(size = 14, family = "Karla", face='bold')) +
#   theme(plot.subtitle = element_text(size=12, family = "Karla", face = "plain")) + 
#     theme(text=element_text(family="Karla")) +
#         theme(legend.key=element_rect(fill="white", colour="white")) +
#   theme(plot.caption = element_text(family="Karla", size=7)) 
# state_suicide_rate_plot


### MUNICIPAL SUICIDES ####

mun_shape <- st_read(here::here("Data/muni_2012gw/Muni_2012gw.shp"))
mun_shape<-st_simplify(mun_shape)


suicides_municipal_yearly <-
  filter(death_certificates, non_natural_causes== 'Suicide') %>% 
  group_by(state_mun_OCUR, ANIO_OCUR) %>% 
  tally()

suicides_municipal_yearly<- merge(x = suicides_municipal_yearly, y = irs, by.x = 'state_mun_OCUR', by.y ='municipal_id' )

suicides_municipal_yearly<-  select (suicides_municipal_yearly,c(state_mun_OCUR, "ANIO_OCUR", "n", "cve_edo","state_name",  "municipal_name", "pop2000", "pop2005", "pop2010", "pop2015"))


suicides_municipal_yearly<- suicides_municipal_yearly %>% 
  mutate(rate= case_when(ANIO_OCUR<=2002 ~ n/(as.numeric(pop2000))*k,    ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ (n/as.numeric(pop2005))*k, 
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ (n/as.numeric(pop2010))*k,
                                          ANIO_OCUR>2013 ~ (n/as.numeric(pop2015))*k), na.rm = TRUE)

municipal_average_suicide<-suicides_municipal_yearly%>%
  group_by(state_mun_OCUR, municipal_name, cve_edo, state_name) %>%
  summarise_at(vars(rate), funs(mean(., na.rm=TRUE)))

mun_shape<- mun_shape %>% 
    mutate(state_mun_OCUR= paste(CVE_ENT, CVE_MUN, sep=""))
 
mun_shape = mun_shape %>% 
    left_join(municipal_average_suicide, by = "state_mun_OCUR")  

mun_shape<- mun_shape %>%
  mutate(rate_cut = cut(mun_shape$rate, c(0,5.2,10.5,13.7,356))) 
colnames(mun_shape)[colnames(mun_shape) == 'state_mun_OCUR'] <- 'region'
colnames(mun_shape)[colnames(mun_shape) == 'rate_cut'] <- 'value'

municipal_suicides_plot<-mxmunicipio_choropleth(mun_shape)+ scale_fill_brewer("Rate/100K", type = "qual", palette= ami_pal(palette="green_orange")(4), na.value=ami_cols("dark grey")) +
  labs(title = "20-years Annual Average Municipal \nSuicide Rate (1998-2017)",
       legend = "Rate (#/100K)", 
       caption = "Source: INEGI, CONAPO and Diego Valle's Blog (https://www.diegovalle.net) ") +
  annotate(geom = "text", x = -95, y = 31, label = "Mexico National \nAverage: 5.2", size = 4, hjust = 0, family="Karla") + annotate(geom = "text", x = -95, y = 30, label = "World Average: 10.5", size = 4, hjust = 0, family="Karla") + annotate(geom = "text", x = -95, y = 29, label = "US Average: 13.7", size = 4, hjust = 0, family="Karla") +
  theme_amiplots

municipal_suicides_plot[["layers"]][[1]][["aes_params"]][["colour"]] <- "transparent"
municipal_suicides_plot

```

```{r create several years municipal level, include=FALSE}
library(purrr)
head(suicides_municipal_yearly)
map_per_year <- function(Yr){
                mun_df <- st_read(here::here("Data/muni_2012gw/Muni_2012gw.shp"))
                mun_df<-st_simplify(mun_df)
                head(mun_df)
                mun_df<- mun_df %>% 
                mutate(state_mun_OCUR= paste(CVE_ENT, CVE_MUN, sep=""))
                
                mun_df = mun_df %>%
                  left_join(suicides_municipal_yearly[suicides_municipal_yearly$ANIO_OCUR==Yr,], by = c("state_mun_OCUR"="state_mun_OCUR"))  
                mun_df<- mun_df %>%
  mutate(rate_cut = cut(mun_df$rate, c(0,8.2,20,50,356))) 
                colnames(mun_df)[colnames(mun_df) == 'state_mun_OCUR'] <- 'region'
                colnames(mun_df)[colnames(mun_df) == 'rate_cut'] <- 'value'
                title_plot = paste0("Municipal Suicide Rate in"," ",Yr)            
                municipal_suicides_plot<-mxmunicipio_choropleth(mun_df)+                 scale_fill_brewer("Rate/100K", type = "qual", palette= ami_pal(palette="green_orange")(4), na.value=ami_cols("dark grey")) +
                labs(title = title_plot,
       legend = "Rate (#/100K)", 
       caption = "Source: INEGI, CONAPO and Diego Valle's Blog (https://www.diegovalle.net) ") +
                  
  theme_amiplots

municipal_suicides_plot<-municipal_suicides_plot[["layers"]][[1]][["aes_params"]][["colour"]] <- "transparent"
                
    ggsave(filename = paste0("mun_suicide",Yr,".png"),
           width = 8,height=8,dpi = 150)
}
```
```{r gif second attempt, include=FALSE}
# library(magick)
# list.files(path = here::here("pngs"), pattern = "*.png", full.names = T) %>% map(image_read) %>% # reads each path file
#   image_join() %>% # joins image
#   image_animate(fps=4) %>% # animates, can opt for number of loops
#   image_write("suicides.gif") # write to current dir
# 
# png.files <- sprintf("mun_suicide%02d.png", 1998:2017) #Mention the number of files to read
# GIF.convert <- function(x, output = "animation.gif")#Create a function to read, animate and convert the files to gif
#         {
#         image_read(x) %>%
#         image_animate(fps = 4) %>%
#         image_write(output)
#         }
# 
#   GIF.convert(png.files)
        
# A.c <- c(mun_suicide1998,mun_suicide.1999,mun_suicide.2000,mun_suicide.2001,mun_suicide.2002,mun_suicide.2003,mun_suicide.2004,mun_suicide.2005,mun_suicide.2006,mun_suicide.2007,mun_suicide.2008,mun_suicide.2009, mun_suicide.2010,mun_suicide.2011,mun_suicide.2012,mun_suicide.2013, mun_suicide.2014, mun_suicide.2015, mun_suicide.2016, mun_suicide.2017)
#   A.img <- image_scale(A.c)
#   A.ani <- image_animate(A.img, fps = 1, dispose = "previous")
#   image_write(A.ani, paste0("A_animation.gif"))

```



