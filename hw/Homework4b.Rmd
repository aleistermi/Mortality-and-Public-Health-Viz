---
title: "Homework 3"
author: "Aleister Montfort"
date: "1/29/2019"
output: 
  html_document:
    css: style.css

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r, message=FALSE, include=FALSE}
library(ggplot2)
library(here)
library(zoo)
#library(lubridate)
library(dplyr)
library(ggridges)
```

```{r, load data, include=FALSE}
here()
path = here("death_certificates.RData")
print(path)
data = load(path)
```
```{r, other data, include=FALSE}
# here()
# path_gini10 = here::here("gini2010.RData")
# load(path_gini10)
# typeof(gini2010)
# file.exists(path_gini10)
# path_gini15 = here::here("gini2015.RData")
# file.exists(path_gini15)
# gini2015 = load(path_gini15)
# pathiris = here::here("irs.RData")
# file.exists(pathiris)
# irs = load(pathiris)
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2015.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2010.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/irs.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/pop_by_cohort.RData")

```


```{r, include=FALSE}
library(here)
path = here::here("irs.RData")
file.exists(path)
irs = load(path)

```

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
## Colors and Palettes ####
ami_colors <- c(
  `red`        = "#ff3333", 
  `green`      = "#318333",
  `blue`       = '#2171b5',
  `light_blue`   = '#eff3ff',
  `orange`     = "#e19509",
  `light grey` = "#f7f7f7",
  `dark grey`  = "#808080")

ami_cols <- function(...) {
  cols <- c(...)

  if (is.null(cols))
    return (ami_colors)

  ami_colors[cols]
}

# ####
# ami_palettes <- list(
#   `redish`  = ami_cols('red', 'orange'),
# 
#   `cool`  = ami_cols('blue', 'green'),
# 
#   `grey`   = ami_cols("dark_grey"),
# 
#   `blue` = ami_cols("blue"),
# 
#   `red`  = ami_cols("red")
# )
# 
# ami_pal <- function(palette = "cool", reverse = FALSE, ...) {
#   pal <- ami_palettes[[palette]]
# 
#   if (reverse) pal <- rev(pal)
# 
#   colorRampPalette(pal, ...)
# }
# 
# scale_color_ami <- function(palette = "cool", discrete = TRUE, reverse = FALSE, ...) {
#   
#   pal <- ami_pal(palette = palette, reverse = reverse)
# 
#   if (discrete) {
#     discrete_scale("colour", paste0("ami_", palette), palette = pal, ...)
#   } else {
#     scale_color_gradientn(colours = pal(256), ...)
#   }
# }
# scale_fill_ami <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
#   pal <- ami_pal(palette = palette, reverse = reverse)
# 
#   if (discrete) {
#     discrete_scale("fill", paste0("ami_", palette), palette = pal, ...)
#   } else {
#     scale_fill_gradient2(colours = pal(256), ...)
#   }
# }
# install.packages("extrafont")

# library(extrafont)
# font_import()
# load(fonts)
```

```{r, prepare data chart 1, include=FALSE}

death_certificates <- subset(death_certificates, year_death>1997 & year_death!=9999)
## CREATE YEAR MONTH VAR ####
death_certificates$yearmonth <- as.yearmon(paste(death_certificates$year_death, death_certificates$month_death), "%Y %m")

death_certificates <- death_certificates%>%
    mutate(non_natural_causes = if_else(is.na(non_natural_causes), "N.A/Natural Death", non_natural_causes))

monthly_death_national <-
  death_certificates %>% 
  group_by(yearmonth, ANIO_OCUR, non_natural_causes) %>% 
  tally()
print.data.frame(head(monthly_death_national))

TOTAL_monthly_death_national <-
  death_certificates %>% 
  group_by(yearmonth, ANIO_OCUR) %>% 
  tally()
```


```{r, adding population, include=FALSE, warning=FALSE}
# library(lubridate)
# monthly_death_national<- 
#   monthly_death_national %>%
#   mutate(year=year(yearmonth))

## ADD POPULATION TO OBTAIN RATES 
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2015.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2010.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/irs.RData")
monthly_death_national<-
  monthly_death_national %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))

TOTAL_monthly_death_national<-
  TOTAL_monthly_death_national %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))

mult<-100000
monthly_death_national<-monthly_death_national %>% 
                        mutate(death_rate=n/pop_divide*mult)
monthly_death_national<-monthly_death_national %>% 
                        mutate(natural= if_else((is.null(non_natural_causes) | non_natural_causes=="N.A/Natural Death"),1,0))
TOTAL_monthly_death_national<-TOTAL_monthly_death_national %>% 
                        mutate(death_rate=n/pop_divide*mult)                      
```
# Introduction 
In the last 12 years, scholars and policy makers have paid special attention to the increase in mortality in Mexico. This attention has focused on explaining the rise in homicides as a consequence of the policies implemented to fight against drug cartels. Though perhaps this is the most important policy challenge for the Mexican authorities and it is a source of regional concerns to the US and other neihghbours, other  patterns of mortality in Mexico receive much less attention. This work aims to explore other characteristics of mortality trends in Mexico, and has a focus on analyzing the pattern of public-health related mortality, especially suicides.

## 1. General Patterns of Mortality
### A. Total Deaths

Chart 1 shows the trend in the overall pattern of mortality in Mexico. It is interesing to note that there is a smooth increase in mortality rates starting in 2005, one year before the so called war on drugs was implemented by former President Felipe Calderon. We can distinguish a period in which monthly mortality rates fluctuated around 30, and then there is a smooth jump above 30.
```{r theme, include=FALSE}
theme_ami<-
  theme(
  panel.background = element_rect(fill = 'white',
                                colour = ami_cols("light grey"),
                                size = 0.3, linetype = "solid"),
  panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                colour = ami_cols("light grey")), 
  panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "dark grey")) +
  theme(plot.title = element_text(size = 14, family = "Karla", face='bold'))+
  theme(plot.subtitle = element_text(size=12, family = "Karla", face = "plain"))+
    theme(text=element_text(family="Karla"))+
     theme( axis.text.x=element_text(colour="black", family = "Karla", size = 10, face = "plain"))+
    theme (axis.text.y=element_text(colour="black", family = "Karla", size = 10, face = "plain"))+
        theme(legend.key=element_rect(fill="white", colour="white")) +
  theme(plot.caption = element_text(family="Karla", size=7)) +
  theme(text = element_text(family = "Karla")) +
  theme(line = element_line(color=ami_cols("green"))) 
  
theme_amiplots<- theme(plot.title = element_text(size = 14, family = "Karla", face='bold'))+
  theme(plot.subtitle = element_text(size=12, family = "Karla", face = "plain"))+
    theme(text=element_text(family="Karla"))+
        theme(legend.key=element_rect(fill="white", colour="white")) +
  theme(plot.caption = element_text(family="Karla", size=7)) +
  theme(text = element_text(family = "Karla")) +
  theme(line = element_line(color=ami_cols("green"))) 

```

```{r, total rate plotline, message=FALSE, echo=FALSE, warning=FALSE}
## TOTAL ####
total_rate_plot = ggplot(TOTAL_monthly_death_national, aes(x=yearmonth, y=death_rate)) +
 geom_line(color=ami_cols("green"))  + 

  stat_smooth(alpha=.04,
    method = "loess", se = FALSE, color= ami_cols("orange"), size=.5 ) +
    ylim(25, 40) +
      labs(title = "1A. Monthly Mortality Rate in Mexico 1998-2017",
       subtitle = "Total deaths rate trend shows is increasing, probably driven by the grow in the homicides-rate",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  geom_vline(xintercept =2006.917 , linetype="dotted", 
                color = ami_cols("orange"), size=.5)+ 
    geom_text(aes(x=2007.1, label="War on drugs starts", y=28, family="Karla"), colour=ami_cols("orange"), hjust = 0) +
  theme_ami
total_rate_plot
```

```{r testing fonts, include=FALSE}
p1 = ggplot(NULL, aes(x = 1, y = 1)) + ylim(0.8, 1.2) +
    annotate("text", 1, 1.0, label = "Karla es esta que obno",
             family = "Karla", size = 5) +
    annotate("text", 1, 1.1, label = "NanumGothic",
             family = "NanumGothic", size = 5) +
    annotate("text", 1, 1.05, label = "MerriweatherSans-BoldItalic",
             family = "MerriweatherSans-BoldItalic", size = 5) +    
    annotate("text", 1, 1.3, label = "HindSiliguri-Regular",
             family = "HindSiliguri-Regular", size = 5) +     
    annotate("text", 1, .94, label = "Dosis-Regular",
             family = "Dosis-Regular", size = 5) +
    annotate("text", 1, .90, label = "Assistant-Regular",
             family = "Assistant-Regular", size = 5) +
    annotate("text", 1, .86, label = "Arvo",
             family = "Arvo", size = 5) +
    annotate("text", 1, .82, label = "Wingdings-Regular",
             family = "Wingdings-Regular", size = 5) +
  theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          axis.text  = element_blank())

p2 = ggplot(NULL, aes(x = 1, y = 1)) + ylim(0.8, 1.2) +
    annotate("text", 1, 1.15, label = "Advent Pro",
             family = "Advent Pro", size = 5) +
    annotate("text", 1, 1.1, label = "IBM Plex Mono" ,
             family = "IBM Plex Mono" , size = 5) +
    annotate("text", 1, 1.05, label = "Economica",
             family = "Economica", size = 5) +    
    annotate("text", 1, 1, label = "Alegreya Sans",
             family = "Alegreya Sans", size = 5) +     
    annotate("text", 1, .94, label = "Cabin Condensed",
             family = "Cabin Condensed", size = 5) +
    annotate("text", 1, .90, label = "Hind Guntur",
             family = "Hind Guntur", size = 5) +
    annotate("text", 1, .86, label = "Domine"  ,
             family = "Domine"  , size = 5) +
    annotate("text", 1, .82, label = "Advent Pro Medium",
             family = "Advent Pro Medium", size = 5) +
  theme(axis.title = element_blank(),
          axis.ticks = element_blank(),
          axis.text  = element_blank())
# font_import(paths = here("fonts (1)")) 
#loadfonts() advent pro economica o karla ("Advent Pro", "IBM Plex Mono", "Economica", "Alegreya Sans", "Cabin Condensed", "Hind Guntur", "Domine")
```


### B. Natural Deaths

Once we only consider natural deaths, we observe a similar behavior as the total deaths. 
```{r, natural deaths plotline, message=FALSE, echo=FALSE, warning=FALSE}
## NATURAL DEATHS ####
natural_death_plot = ggplot(subset(monthly_death_national,natural== 1 ), aes(x=yearmonth, y=death_rate)) +
  ylim(20, 40) +
  ylab('Monthly Rate') +
  geom_line(color=ami_cols("green"))  +
   labs(title = "1B. Natural Deaths Mortality Rate in Mexico 1998-2017",
       subtitle = "Once we exclude non-natural causes, we observe that rates in deaths has also increased in Mexico",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  stat_smooth(
   method = "loess", se = FALSE, color= ami_cols("orange"), size=.5) +
  xlab("") + 
  theme_ami
natural_death_plot

```

### C. Suicides

In a recent article (https://econ.st/2WuSTSN), the British magazine "The Economist" notes that the is a global trend in the decline of suicides, mostly driven by China, India and Russia. But they note that America is the big exception: this century its suicides rate has grown 18%, and if 20 years ago China's rate double America's, this relationship has been reversed.
Perhaps for its smaller size as compared to India or China, the article does not mention Mexico, but as the chart below shows, there has been a sharp increase in suicides in the last 20 years, a period in which the rate almost doubles. Later in this work I aim to explore the data to answer some basic questions like: who are these people? where and when this phenomenon occur? and what are the characteristics of this group?

```{r, suicides plotline, message=FALSE, echo=FALSE, warning=FALSE}

## Suicides ####
suicide_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("Suicide")), aes(x=yearmonth, y=death_rate)) +
  ylim(.1, .6) +
  ylab('Monthly Rate') +
  geom_line(color=ami_cols("green"))  +
 labs(title = "1C. Suicides: Ramping up",
       subtitle = "Suicides rate have increased in the last 20 years. On average, they have doubled, whereas in\nthe rest of the world, the opposite trend persists",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  theme_ami
suicide_plot
```

### D. Accidents

On the opposite side, we observe an important reduction in the number of people who died in an accident. The peak in the rate of deaths caused by accidents occured in December 2000, and it has remained stable since 2010.

```{r, Accidents Plotline, message=FALSE, echo=FALSE, warning=FALSE}
## Accidents ####
max_acident<-max(monthly_death_national[monthly_death_national$non_natural_causes == "Accident",]$death_rate)
accidents_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("Accident")), aes(x=yearmonth,y=death_rate))+

  ylim(2, 5) +
  ylab('Monthly Rate') +
  geom_line(color=ami_cols("green"))  +
  labs(title = "1D. Dwindling accidents",
       subtitle = "Accident-related deaths show a smooth decrease in the last 20 years",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  geom_vline(xintercept =2001 , linetype="dotted", 
                color = ami_cols("orange"), size=.5) + 
  geom_text(aes(x=2001.2, label="December 2000: maximum \nmonthly rate in 20 years (4.8)", y=2.5), colour=ami_cols("orange"), hjust = 0) +
theme_ami
accidents_plot
        
```

### E. Homicides
This is probably the chart that has received the most detailed analysis by scholars in Mexico in recent years. We can distinguish four periods. First, before 2006, we observe a secular decline in the rate of homicides. Using other data sources, we observe how this trend had at least 20 years of decline before 2006, and it was mostly explained because a land reform, implemented during the eighties, put an end to conflicts around land-owning disputes that usually ended with violence. Second, this declining trend ended with the implementation of the so called 'war on drugs', which premise was to use the military forces to dismantle drug cartels. We observe a sharp increase in homicides rate until 2011, and then a third short period in which the rate decreased. Then, after 2015, the rate increased again.

```{r, Homicides plotline, message=FALSE, echo=FALSE, warning=FALSE}
## Homicides ####
homicide_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("Homicide")), aes(x=yearmonth, y=death_rate)) +
  ylim(0, 2.5) +
  ylab('Monthly Rate') +
  geom_line(color=ami_cols("green"))  +
  ylab('Monthly Rate') +
  geom_vline(xintercept =2006.917 , linetype="dotted", 
                color = ami_cols("orange"), size=.5)+ 
    geom_text(aes(x=2007.1, label="War on drugs starts", y=.20), colour=ami_cols("orange"), hjust = 0) +
labs(title = "1E. Homicides rate: an upward trend",
       subtitle = "After a substantive decrease between 2011-2015, homicides rate shows a sharp upward trend",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")+
theme_ami
homicide_plot
```

### F. War operations related deaths

This is a pretty much new classification that started to be used in the certificate deaths in 2004. We can distinguish a period between 2011 and 2015 in which both the month-to-month levels and variation in this rate increased. As the chart shows, the spikes are more frequent and of larger magnitude. Then, after this period, the spikes become shorter and the rate decreased too. I assume that these deaths are related to the army forces that lost their lives in different operations, mostly related to the fight against drug cartels. An interesting hypothesis to explore is the fact that this period of large variation also corresponds to the period of homicides decline, suggesting that a major involvement of the army forces may had a dissuasive effect on the probability of commiting homicides. 
```{r, wat deaths plotline, message=FALSE, echo=FALSE, warning=FALSE}
## WAR DEATHS #### jun 2010
war_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("War Operations") & ANIO_OCUR>2003), aes(x=yearmonth, y=death_rate)) +
  ylim(0, .03) +
  ylab('Monthly Rate') +
  geom_line(color=ami_cols("green"))  +
  stat_smooth(
    color = ami_cols("orange"), alpha=.04,
    method = "loess", se = FALSE) +
  geom_vline(xintercept =2010.417, linetype="dotted", 
                color = ami_cols("orange"), size=.5)+
   geom_vline(xintercept =2015.083, linetype="dotted", 
                color = ami_cols("orange"), size=.5)+ 
  geom_text(aes(x=2012.417, label="Decrease in \n homicides rate", y=.0265), colour=ami_cols("orange")) +
    labs(title = "1F. War operations: the costs of decreasing the homicides rate?",
       subtitle = "Deaths show a greater variance and levels between 2011 and 2015, \na coincident period with the temporal drop in homicides",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  
theme_ami
war_plot

```

### G. Deaths with no classification
This classification correspond to non-natural casuses of death that were not classified. This chart shows an interesting behavior of deaths in this category. They follow a similar pattern as the homicides' one: a relative decline up to the mid 2000's; then an increase between 2010 and 2012, followed by a decrease up to around 2015. After this, we are observing an upward trend of these deaths. Finally, we should just underline that this inability to register non-natural cause deaths reflects in the best case a deterioration in the state capacity to keep the record of deaths, and in a context of the increase in violence, gives rise to doubts about the way the authorities collect and present information.

```{r, dont know plotlines, message=FALSE, echo=FALSE, warning=FALSE}

## DONT KNOW DEATHS####
dn_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("Don't know")), aes(x=yearmonth, y=death_rate)) +
  ylim(0.1, .5) +
  ylab('Monthly Rate') +
  geom_line(color=ami_cols("green"))  +
 geom_text(aes(x=2012.8, label="Decrease in \n homicides", y=.18), colour=ami_cols("orange")) +
  geom_vline(xintercept =2010.417, linetype="dotted", 
                color = ami_cols("orange"), size=.5)+
   geom_vline(xintercept =2015.083, linetype="dotted", 
                color = ami_cols("orange"), size=.5)+
    labs(title = "1G. State's inability to produce vital stats",
       subtitle = "There is a significant increase in these classification of deaths, which reflects an increasing \nlack of State capacity to classify deaths",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
theme_ami
dn_plot
```
```{r palette, include=FALSE}
ami_palettes <- list(
  `redish`  = ami_cols('red', 'orange'),

  `cool`  = ami_cols('blue', 'green'),
  
  `multi`  = ami_cols('red', 'orange', 'green', 'blue', 'grey', 'dark grey'),

  `grey`   = ami_cols("dark_grey"),

  `blue` = ami_cols("blue"),

  `red`  = ami_cols("red"),
  `green_orange`  = ami_cols("green", "orange")
)

ami_pal <- function(palette = "cool", reverse = FALSE, ...) {
  pal <- ami_palettes[[palette]]

  if (reverse) pal <- rev(pal)

  colorRampPalette(pal, ...)
}

scale_color_ami <- function(palette = "cool", discrete = TRUE, reverse = FALSE, ...) {

  pal <- ami_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("colour", paste0("ami_", palette), palette = pal, ...)
  } else {
    scale_color_gradientn(colours = pal(256), ...)
  }
}
scale_fill_ami <- function(palette = "main", discrete = TRUE, reverse = FALSE, ...) {
  pal <- ami_pal(palette = palette, reverse = reverse)

  if (discrete) {
    discrete_scale("fill", paste0("ami_", palette), palette = pal, ...)
  } else {
    scale_fill_gradient2(colours = pal(256), ...)
  }
}


```

## 2. Suicides in Mexico

To create this chart, I re-grouped the classification coming in the databases (which use the [International Classification of Diseases](https://www.who.int/classifications/icd/en/)) into 13 categories, and then I wanted to show which causes of death are more prevalent along age ([I got inspired from Nathan Yau's chart](https://flowingdata.com/2016/01/05/causes-of-death/)). The chart only shows the cause of death for males. As expected, some causes of death are more prevalent for young than for old people and viceversa. For instance, suicides affect mostly younf people; and as you get older, the chances of dying by a respiratory system related cause increases. 

```{r suicide_by_occupation and ange, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE}
suicides_occupation<- death_certificates %>% select(non_natural_causes,sex,school_category, occupation, age_years)

suicides_occupation_male <- filter(suicides_occupation, non_natural_causes=="Suicide" & sex=="Male" & age_years>=25 & age_years<=50)

suicides_occupation_male = suicides_occupation_male %>% 
                              mutate(occupation =                                        if_else(occupation=='55',"Industrial/Manufacturing/Transport worker", occupation))
suicides_occupation_male = suicides_occupation_male %>% 
                              mutate(occupation =                                        if_else(occupation=="Looking for Job" | occupation=='Not Working',"Not Working/Looking for a job", occupation))

suicides_occupation_male = suicides_occupation_male %>% 
                              mutate(occupation =                                        if_else(occupation=="Informal seller (Vend. Amb)"| occupation=="Domestic/House Services","Informal Worker", occupation))

normalized_suic_age_male<- suicides_occupation_male %>% 
  group_by(age_years, occupation) %>% 
  tally() %>% 
group_by(age_years) %>% mutate(percent = n/sum(n)*100)

normalized_suic_age_male$ordered_vars <- factor(normalized_suic_age_male$occupation, levels=c("NA", "Not Working/Looking for a job", "Artisan/Auxiliary Workers", "Primary Sector Worker", "Surveillance-Personal Services", "Informal Worker", "Industrial/Manufacturing/Transport worker", "Admin Work", "Salesman", "White Collar", "Professional-Technical worker", "Personal Services at businesses" ))

#, show.legend = FALSE
size_parameter<-2.5
occupation_plot<-ggplot(normalized_suic_age_male, aes(x=age_years, y=percent, fill=ordered_vars)) +  
  geom_area(size=.05, alpha=.7, color='black' , show.legend = FALSE) +
scale_fill_manual(values=ami_pal("multi")(12)) +
    geom_text(aes(x=47, label="No information", y=95), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Not working/Looking for a Job", y=78), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Artisan/Auxiliary Workers", y=67), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Primary Sector", y=55), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Surveillance/Personal Services", y=45), colour="white", size=size_parameter) +
    geom_text(aes(x=28, label="Peddlers/Domestic Work", y=40), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Industrial/Manufacturing/\nTransport", y=28), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Administrative", y=17), colour="white", size=size_parameter) +
    geom_text(aes(x=45, label="Sales", y=10), colour="white", size=size_parameter) +
    geom_text(aes(x=48, label="White Collar", y=6), colour="white", size=size_parameter) +
    geom_text(aes(x=43, label="Professional/Technical", y=3.5), colour="white", size=size_parameter) +
    geom_text(aes(x=28, label="Personal Services", y=1.75), colour="white", size=size_parameter) +
  labs(title = "2. Suicide Cases by Ocupation and Age",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Age", y = "%") +
       theme(plot.title = element_text(lineheight=.8, face="bold")) +
theme_ami
occupation_plot
```


```{r causes pressure, echo=FALSE, warning=FALSE, message=FALSE, include=FALSE, error=FALSE}
# causes<- death_certificates %>% select(cause_of_death,sex,school_category, age_years)
# 
# causes_male <- filter(causes, cause_of_death!= 'HOMICIDES' & cause_of_death!= 'WAR OPERATIONS' & cause_of_death!= 'OTHER ACCIDENT' & cause_of_death!= 'AIR, WATER, OTHER TRANSPORT ACC' & sex=="Male")
# 
# 
# causes_male = causes_male %>% 
#                               mutate(cause_of_death = if_else( 
#                                 cause_of_death=='AFTERMATH' | 
#                                 cause_of_death=='PERINATAL PERIOD ILLNESS' | 
#                                 cause_of_death=='ABNORMAL CLINIC LAB' |
#                                 cause_of_death=='MEDICAL ASSIST' | cause_of_death=='EYE ILLNESS'| 
#                                 cause_of_death=="LEGAL DRUG ABUSE"|cause_of_death=='DIGESTIVE SYSTEM', 'OTHER', cause_of_death))
# causes_male = causes_male %>% 
#                               mutate(cause_of_death = if_else( 
#                                 cause_of_death=='DRUG_USE_LEGAL', 'LEGAL DRUG ABUSE', cause_of_death))
# causes_male = causes_male %>% 
#                               mutate(cause_of_death = if_else( 
#                                 cause_of_death=='HIV', 'AIDS', cause_of_death))
# causes_male = causes_male %>% 
#                               mutate(cause_of_death = if_else( 
#                                 cause_of_death=='CONGENITAL MALF', 'CONGENITAL MALFORMATIONS', cause_of_death))
# causes_male = causes_male %>% 
#                               mutate(cause_of_death = if_else( 
#                                 cause_of_death=='OSTEOMUSCULAR CONJ', 'OSTEOMUSCULAR AND CONJUNCTIVE DISEASES', cause_of_death))
# 
# 
# causes_normalized_age_male<- causes_male %>% 
#   group_by(age_years, cause_of_death) %>% 
#   tally() %>% 
# group_by(age_years) %>% mutate(percent = n/sum(n)*100)
# 
# causes_normalized_age_male$ordered_vars <- factor(causes_normalized_age_male$cause_of_death, levels=c("OTHER", "CONGENITAL MALFORMATIONS","GENITOURINARY","OSTEOMUSCULAR AND CONJUNCTIVE DISEASES","CIRCULATORY SYSTEM", "INFECTION NO HIV", "AIDS", "MENTAL ILLNESS" , "CANCER", "NERVOUS SYSTEM ILLNESS",  "RESPIRATORY SYSTEM", "SUICIDES" ))
# size_parameter<-2.5
# causesplot<-ggplot(causes_normalized_age_male, aes(x=age_years, y=percent, fill=cause_of_death)) + 
#     geom_area( size=.05, alpha=.7, color='black' , show.legend = FALSE) +
#     geom_text(aes(x=25, label="Other", y=98), colour="white", size=size_parameter) +
#     geom_text(aes(x=85, label="Congenital Malformations", y=90), colour="white", size=size_parameter) +
#     geom_text(aes(x=85, label="Genitourinary", y=80), colour="white", size=size_parameter) +
#     geom_text(aes(x=75, label="Osteomuscular and Conjuctive Diseases", y=74), colour="white", size=size_parameter) +
#     geom_text(aes(x=85, label="Circulatory System", y=68), colour="white", size=size_parameter) +
#     geom_text(aes(x=85, label="Infections", y=58), colour="white", size=size_parameter) +
#     geom_text(aes(x=34, label="AIDS", y=48), colour="white", size=size_parameter) +
#     geom_text(aes(x=58, label="Mental Illness", y=44), colour="white", size=size_parameter) +
#     geom_text(aes(x=30, label="Cancer", y=30), colour="white", size=size_parameter) +
#     geom_text(aes(x=75, label="Nervous System", y=8), colour="white", size=size_parameter) +
#     geom_text(aes(x=75, label="Respiratory System", y=3), colour="white", size=size_parameter) +
#     geom_text(aes(x=23, label="Suicides", y=3), colour="white", size=size_parameter) +
#   labs(title = "2. Principal Male Mortality Causes in Mexico by Age",
#        caption = "Source: National Institute of Statistics and Geography (INEGI)", 
#        x = "Age", y = "%") +
#        theme(plot.title = element_text(lineheight=.8, face="bold")) +
# theme_ami
# causesplot
```



### B. Male and Female Suicides

What are the some of the characteristics of suicides in Mexico? The chart below analyzes the distribution of ages across males and females, and aims to explore if there is a change in the age composition of suicides in the last 20 years. The Economist's article emphasizes that the drop in suicides around the world is driven by three groups: young women in China and India; middle-age men in Russia and old people all around the world. Then, a pertinent question is which groups explain the rise in suicides?

The first thing to note is that suicides are more prevalent among young and males (though with these charts I do not intend to support the argument that it is more prevalent in males). The mean age for males is around 36.1 years old, and for females is 30.5 across period 1998-2017. The chart on top shows the distribution of ages for males ([this code comes from here](https://socviz.co/refineplots.html)). From this chart, it is important to notice that across the years, the curves have flattened, suggesting that suicides are becoming more prevalent in middle-age groups (i.e. the 1998 distribution was more compact and peaked than the 2017 distribution, which left tail is getting longer, concentraring its mass distribution on the right). In fact, the average age ot death for males went from  34.6 in 1998 to 36.1, and for females from 28.9 to 31.6. This flattening of the curve is also notable for females.

```{r violinsplot, echo=FALSE}
library(ggridges)
suicides_by_sex<- death_certificates %>% select(non_natural_causes,sex, age_years, year_death)

suicides_by_sex <- subset(suicides_by_sex, (non_natural_causes=="Suicide") & (year_death==1998 | year_death==2008 |year_death==2017)  & sex!="Not specified") 

stat_sum_df <- function(fun, geom="crossbar", ...) {
  stat_summary(fun.data = fun, colour = "red", geom = geom, width = 0.2, ...)
}
#subset(suicides_by_sex, sex=="Male")
violines<-ggplot(suicides_by_sex, aes(y=age_years, x=sex, fill=sex)) +
  geom_violin(trim = FALSE, draw_quantiles = c(0.25, 0.5, 0.75))  + 
  facet_wrap(~ year_death)+ stat_summary(fun.y=mean, geom="point", shape=23, size=2)
violines

```


```{r, warning=FALSE, message=FALSE, error=FALSE, echo=FALSE, include=FALSE}
library(ggridges)
suicides_national<- death_certificates %>% select(non_natural_causes,sex,school_category, age_years, year_death)

suicides_male <- filter(suicides_national, non_natural_causes=="Suicide" & sex=="Male")
suicides_male<-suicides_male  %>%
  mutate(year_death=as.character(year_death))

suicides_female <- filter(suicides_national, non_natural_causes=="Suicide" & sex=="Female")
suicides_female<-suicides_female  %>%
  mutate(year_death=as.character(year_death))

mean_age_m <- suicides_male %>%
    select(age_years, year_death) %>%
    group_by(year_death) %>%
    summarize(xbar = (mean(age_years, na.rm = TRUE)))
mean_age_f <- suicides_female %>%
    select(age_years, year_death) %>%
    group_by(year_death) %>%
    summarize(xbar = (mean(age_years, na.rm = TRUE)))

ggplot(ToothGrowth, aes(x=dose, y=len, fill=supp)) +
  geom_violin()


## I copied the code from https://socviz.co/refineplots.html 
plot_ages_male <- ggplot(data = suicides_male,
            mapping = aes(x = age_years, y = factor((year_death)),
                                     ordered = TRUE))+
  geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 1.5) +
    scale_x_continuous(breaks = c(15,25,35, 50, 65, 80)) +
    scale_y_discrete(expand = c(0.01, 0)) + 
    #geom_vline(data = mean_age_m, aes(xintercept =xbar ), linetype = "dashed") +
    labs(x = "Age", y = NULL,
         title = "3A1. Age Distribution of\n Male Suicide Cases in Mexico 1998-2017") +
    theme_ridges() +
    theme_ami
##females####
plot_ages_female <- ggplot(data = suicides_female,
            mapping = aes(x = age_years, y = factor((year_death)),
                                     ordered = TRUE))+
  geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 1.5) +
    scale_x_continuous(breaks = c(15,25,35, 50, 65, 80)) +
    scale_y_discrete(expand = c(0.01, 0)) + 
    ### NEED TO ADD MEAN geom_vline(data = suicides_male, aes(xintercept = grp.mean), linetype = "dashed")
    labs(x = "Age", y = NULL,
         title = "3A2. Age Distribution of\n Female Suicide Cases in Mexico 1998-2017") +
    theme_ridges() +
    theme(title = element_text(size = 16, face = "bold")) 
plot_ages_female
```

### B. Suicides and Population

The first chart below plots the annual suicide rate (cases per 100 thousand inhabitants) and municipality's population size. The data to create this chart was censored for municipalities that have more than 100,000 inhabitants, which are only a small hand of cities with low suicide rates. Then, across all municipalities, the rates of suicides are pretty similar, but after a certain size threshold (around 25 thousand inhabitants), the rate increases much more. Otherwise said, municipalities that are small in size present the largest rate of homicides.
The chart below present a similar information, but plots on the y axis the average annual change rate in suicides rate for the entire sample period (1998-2017). Again, smaller municipalities show the fastest increase in the rate of homicides.

```{r, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
####### SUICIDES AND POPULATION #####
# First I want to create average change in suicide rate
library(lubridate)
library(stringi)

suicides_municipal_month <-
  filter(death_certificates, non_natural_causes== 'Suicide') %>% 
  group_by(state_mun_OCUR, ANIO_OCUR) %>% 
  tally()

suicides_municipal_month %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))
pop15<-irs[,c('pop2015', 'municipal_id')]

suicides_municipal_month<- merge(x = suicides_municipal_month, y = pop15, by.x = 'state_mun_OCUR', by.y ='municipal_id' )
suicides_15<-(subset(suicides_municipal_month, suicides_municipal_month$ANIO_OCUR==2015))

suicides_15<- suicides_15 %>%
  mutate(rate_suic_15 = n/pop2015*100000)
suicides_municipal_month<-suicides_municipal_month%>%
  mutate(diff_perc_rate = (((n/pop2015)  - lag((n/pop2015)))/lag((n/pop2015))))


mean_suicide<-suicides_municipal_month  %>%
  group_by(state_mun_OCUR) %>%
  summarise_at(vars(diff_perc_rate), funs(mean(., na.rm=TRUE)))

mean_suicide <- merge(x = mean_suicide, y = irs, by.x = 'state_mun_OCUR', by.y ='municipal_id' )
mean_suicide <- merge(x = mean_suicide, y = gini2015, by.x = 'state_mun_OCUR', by.y ='id_municipal_gini' )
mean_suicide <- merge(x=mean_suicide, y = suicides_15, by.x='state_mun_OCUR', by.y = 'state_mun_OCUR')
mean_suicide<-mean_suicide  %>%
  mutate(income_ratio=as.numeric(income_ratio))
mean_suicide<-mean_suicide  %>%
  mutate(rank15=as.numeric(rank15))

suicides_rate_plot <- ggplot(subset(mean_suicide, mean_suicide$pop2015.x<100000), aes(x=pop2015.x, y=diff_perc_rate))+  # rate_suic_15
 geom_point(bins = 30, alpha=.95) + 
  
  ggtitle("3B1. Smaller and Rural Municipalities have the largest \nsuicides rates in the country")+
  labs( subtitle = "(Rate of Suicides per 100K inhabitants 2015 (NEED TO CORRECT OR DELETE))",
      caption="Source: INEGI and CONAPO,Sample limited to n\ population<100,000 and suicide rate<100", x = "Population", y = "Annual Rate (per 100k)") +
      theme_ami


scaleFUN <- function(x) sprintf("%.2f", x)

suicides_ratechange_plot <- ggplot(subset(mean_suicide, rate_suic_15>=12), aes(x=pop2015.x, y=rate_suic_15, size=pop2015.x))+ geom_jitter()+
  ggtitle("3B2. Smaller and Rural Municipalities also show the largest rate of \n growth in the last 20 years")+
  labs( subtitle = "Average rate of growth 1999-2017",
      caption="Source: INEGI and CONAPO" ,x = "Population", y = "Rate (%)") +
  #      theme(plot.title = element_text(lineheight=.8, face="bold")) +
  # scale_x_continuous(trans='log',name ="logpopulation", labels=scaleFUN) 
theme_ami

suicides_ratechange_plot
```

### C. Time patterns in Suicides

Differences across cohorts are remarkable. The suicides rate shows the largest increase among the young: for the 15-35 years old cohort, it increased from around 6 cases per 100k inhabitants, to a little bit more than 8 in 2017. This growth is also remarkable among the 35-50 cohort, which rose from around 5 to 7 cases per 100k. Among the 50-70 cohort we observe an relatively stable average (though it may seem to exist a seasonality pattern). Finally, in the elder cohort we see a continous drop in suicides (from around 7 to around 5 cases per 100k).
```{r cohort trends data, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
suicides_by_cohort<-death_certificates[which(death_certificates$non_natural_causes=="Suicide"),] 
# Let's re arrange the cohort population dataset#
library(reshape2)
pop_cohort2 <- melt(pop_by_cohort, id=c("cohort"))
colnames(pop_cohort2)[colnames(pop_cohort2)=="variable"] <- "year_merge"
colnames(pop_cohort2)[colnames(pop_cohort2)=="value"] <- "population"
colnames(pop_cohort2)[colnames(pop_cohort2)=="cohort"] <- "age_cohort"
pop_cohort2$year_merge1<-as.numeric(pop_cohort2$year_merge)
pop_cohort2<-pop_cohort2 %>% 
  mutate(year_merge1 = case_when(year_merge1==1 ~ 1995,
                                           year_merge1==2 ~ 2000,
                                           year_merge1==3 ~ 2005,
                                           year_merge1==4 ~ 2010,
                                           year_merge1==5 ~ 2015))

pop_cohort2$year_merge <- NULL
colnames(pop_cohort2)[colnames(pop_cohort2)=="year_merge1"] <- "year_merge"

suicides_by_cohort <-suicides_by_cohort %>%  mutate(age_cohort = case_when(age_years<15 ~ 'Less than 15',
                                           age_years>=15 & age_years<35 ~ '15 to 35',
                                           age_years>=35 & age_years<50 ~ '35 to 50',
                                           age_years>=50 & age_years<70 ~ '50 to 70',
                                           age_years>=70 ~ 'More than 70'))

suicides_by_cohort_total <-
  suicides_by_cohort %>% 
  group_by(age_cohort, year_death) %>% 
  tally()

suicides_by_cohort_total<-suicides_by_cohort_total %>% 
  mutate(year_merge = case_when(year_death<2000 ~ 1995,
                                           year_death>=2000 & year_death<=2004 ~ 2000,
                                           year_death>=2005 & year_death<= 2009 ~ 2005,
                                           year_death>=2010 & year_death<= 2015 ~ 2010,
                                           year_death>2015 ~ 2015))

final_suicides_by_cohort <- dplyr:: left_join(suicides_by_cohort_total, pop_cohort2,
                                              by=c("age_cohort"="age_cohort", "year_merge"="year_merge"))

final_suicides_by_cohort<-final_suicides_by_cohort  %>%
   mutate(rate_suicides_bycohort = n/population*100000)

final_suicides_by_cohort$ordered_cohort <- factor(final_suicides_by_cohort$age_cohort, levels = c("Less than 15", "15 to 35", "35 to 50", "50 to 70", "More than 70"))

```

```{r cohorts plot, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE,  results='hide'}
cohortsplot=ggplot(final_suicides_by_cohort %>% filter(!is.na(ordered_cohort) & ordered_cohort!="Less than 15"), aes(x=year_death, y=rate_suicides_bycohort)) +
  geom_step(color=ami_cols("green")) +
  facet_wrap(~ ordered_cohort)+
  ggtitle("Suicides are ramping up among young population")+
  labs( subtitle = "Rates of suicides by age cohort",
      caption="Source: INEGI and CONAPO" ,x = "Year", y = "Rate/100K") +
  theme(
  panel.background = element_rect(fill = 'white',
                                colour = ami_cols("light grey"),
                                size = 0.3, linetype = "solid"),
  panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                colour = ami_cols("light grey")), 
  panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
                                colour = "dark grey")) +
  theme_ami
cohortsplot
```

The heatmaps below analyze the temporal pattern of suicides occurence. An intervention aimed to prevent suicides should consider when suicides are more likely to occur. The heatmaps below show time patterns between male and female suicide cases. Whereas for males the likelihood of suicide occurence is greater during the weekends (the horizontal blocks for Sunday and Monday), and in any day around midnight (the vertical line on zero), these patterns do not exist in the female cases. Rather, the distribution of cases across days and times is more homogenous.[^1]

[^1]: Note that the scales are different

```{r suicide heatmap, echo=FALSE, warning=FALSE, message=FALSE, error=FALSE, results='hide'}
## Suicide time heatmap####
daily_suicides<-death_certificates[which(death_certificates$non_natural_causes=="Suicide"),] 
daily_suicides <-  daily_suicides  %>%
  mutate(day_of_suicide=weekdays(as.Date(date_death)))


daily_suicides$numeric_time<- as.POSIXct(daily_suicides$time_death, format = "%H:%M:%S")
daily_suicides$hour_suicide <- hour(daily_suicides$numeric_time)

test_suicides <-
  daily_suicides %>% 
  group_by(hour_suicide, day_of_suicide, sex) %>% 
  tally()

test_suicides$day_of_suicide <- factor(test_suicides$day_of_suicide, levels = c( "Friday","Thursday", "Wednesday", "Tuesday",  "Monday",  "Sunday", "Saturday" ))
#c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))


## Male Plot ####
heat_map_suicide_male <- ggplot(test_suicides %>% filter(!is.na(day_of_suicide) & sex=='Male'), aes(hour_suicide, day_of_suicide,  fill=n)) +  
 geom_tile(aes(fill = n), color="white") +
      scale_fill_gradient(low = "white", high = ami_cols('green')) + #scale_x_discrete(position = "top")+
    scale_x_continuous(position = "top", breaks=test_suicides$hour_suicide) +
  
  ggtitle("Time Patterns in Suicides")+
  labs( subtitle = " Male suicides occur around midnight all weekdays, \nand mostly on weekends, whereas female suicides \nare more evenly distributed in the weekdays",
      caption="" ,x = "Time", y="") +
  labs(fill = "# Male Suicides") +
  theme_ami +
  theme(axis.text.x=element_text(size=6))
  
## Female Plot ####

heat_map_suicide_female <- ggplot(test_suicides %>% filter(!is.na(day_of_suicide) & sex=="Female"), aes(hour_suicide, day_of_suicide,  fill=n)) +  
 geom_tile(aes(fill = n), color="white") +
    scale_fill_gradient2 (low = "white", high = ami_cols('orange'))  +
  # scale_fill_ami(discrete=TRUE,palette = "redish", guide = "none") +
#scale_fill_gradient2(high = "darkred") + #scale_x_discrete(position = "top")+
    scale_x_continuous(position = "top", breaks=test_suicides$hour_suicide) +
  
  labs( #subtitle = "Average rate of growth 1999-2017",
      caption="Source: INEGI and CONAPO" ,x = "", y="") +
  labs(fill = "# Female Suicides") +
   theme_ami +
  theme(axis.text.x=element_text(size=6))
library(cowplot)
library(egg)
heatmaps<-ggarrange(heat_map_suicide_male, heat_map_suicide_female, ncol=1)
#heatmaps
# heatmaps<-plot_grid(heat_map_suicide_male, heat_map_suicide_female, ncol=1, nrow=1, align = "hv", axis='l', rel_widths = 1, rel_heights = 1) 
# heatmaps
## HOMICIDES########
# daily_homicides<-death_certificates[which(death_certificates$non_natural_causes=="Homicide"),] 
# daily_homicides <-  daily_homicides  %>%
#   mutate(day_of_homicide=weekdays(as.Date(date_death)))
# 
# 
# daily_homicides$numeric_time<- as.POSIXct(daily_homicides$time_death, format = "%H:%M:%S")
# daily_homicides$hour_homicide <- hour(daily_homicides$numeric_time)
# 
# daily_homicides <-
#   daily_homicides %>% 
#   group_by(hour_homicide, day_of_homicide) %>% 
#   tally()
# 
# daily_homicides$day_of_homicide <- factor(daily_homicides$day_of_homicide, levels = c("Sunday",  'Saturday', 'Friday', "Thursday",  "Wednesday", "Tuesday", "Monday" ))
# 
# p_hom <- ggplot(daily_homicides %>% filter(!is.na(day_of_homicide)), aes(hour_homicide, day_of_homicide,  fill=n)) +  
#   # stat_density(aes(fill = stat(count)), geom = "raster", position = "identity") +
#   # #geom_raster() +
#   #geom_raster() 
#  #stat_density(aes(fill = stat(density)), geom = "raster", position = "identity")
#  geom_tile(aes(fill = n), color="white") +
# scale_fill_gradient2(high = "darkred") + #scale_x_discrete(position = "top")+
#     scale_x_continuous(position = "top", breaks=daily_homicides$hour_homicide) +
#   ggtitle("Homicides by weekday and time of the day")+
#   labs( #subtitle = "Average rate of growth 1999-2017",
#       caption="Source: INEGI and CONAPO" , x = "Time", y = "Day") +
#   theme(
#   panel.background = element_rect(fill = 'white',
#                                 colour = ami_cols("light grey"),
#                                 size = 0.3, linetype = "solid"),
#   panel.grid.major = element_line(size = 0.15, linetype = 'solid',
#                                 colour = ami_cols("light grey")), 
#   panel.grid.minor = element_line(size = 0.1, linetype = 'solid',
#                                 colour = "dark grey")) +
#   theme(plot.title = element_text(size = 14, family = "Georgia-Bold"))+
#   theme(plot.subtitle = element_text(size=12, family = "Georgia", face = "plain"))+
#     theme(text=element_text(family="Georgia"))+
#      theme(  axis.text.x=element_text(colour="black", family = "Georgia", size = 7, face = "plain"))+
#     theme (axis.text.y=element_text(colour="black", family = "Georgia", size = 10, face = "plain"))+
#         theme(legend.key=element_rect(fill="white", colour="white")) +
#   theme(plot.caption = element_text(family="Georgia", size=7))


```





```{r, include=FALSE}
# theme<- theme(element_line(colour = "blue", size = 6, linetype = "solid",
#   lineend = round), rect, text, title, aspect.ratio, axis.title, axis.title.x,
#   axis.title.x.top, axis.title.x.bottom, axis.title.y, axis.title.y.left,
#   axis.title.y.right, axis.text, axis.text.x, axis.text.x.top,
#   axis.text.x.bottom, axis.text.y, axis.text.y.left, axis.text.y.right,
#   axis.ticks, axis.ticks.x, axis.ticks.x.top, axis.ticks.x.bottom,
#   axis.ticks.y, axis.ticks.y.left, axis.ticks.y.right, axis.ticks.length,
#   axis.line, axis.line.x, axis.line.x.top, axis.line.x.bottom, axis.line.y,
#   axis.line.y.left, axis.line.y.right, legend.background, legend.margin,
#   legend.spacing, legend.spacing.x, legend.spacing.y, legend.key,
#   legend.key.size, legend.key.height, legend.key.width, legend.text,
#   legend.text.align, legend.title, legend.title.align, legend.position,
#   legend.direction, legend.justification, legend.box, legend.box.just,
#   legend.box.margin, legend.box.background, legend.box.spacing,
#   panel.background, panel.border, panel.spacing, panel.spacing.x,
#   panel.spacing.y, panel.grid, panel.grid.major, panel.grid.minor,
#   panel.grid.major.x, panel.grid.major.y, panel.grid.minor.x,
#   panel.grid.minor.y, panel.ontop, plot.background, plot.title,
#   plot.subtitle, plot.caption, plot.tag, plot.tag.position, plot.margin,
#   strip.background, strip.background.x, strip.background.y,
#   strip.placement, strip.text, strip.text.x, strip.text.y,
#   strip.switch.pad.grid, strip.switch.pad.wrap, ..., complete = FALSE,
#   validate = TRUE)

```

```{r load data for maps, echo=FALSE, warning=FALSE, include=FALSE, results='hide', message=FALSE}
# install.packages(c("cowplot", "googleway", "ggrepel", 
# "ggspatial", "libwgeom", "sf", "rnaturalearth", "rnaturalearthdata", "rgeos"))
#load(here("Data/diego_valle/mxmunicipio.map.RData"))
load(here::here("Data/diego_valle/df_mxstate.RData"))

```

```{r maps, echo=FALSE,message=FALSE, echo=FALSE, results='hide',warning=FALSE}


library('rgdal')
library("sf")



#rm(list = ls())
k<-100000


## States ####
suicides_state_yearly <-
  filter(death_certificates, non_natural_causes== 'Suicide') %>% 
  group_by(state_ocur, ANIO_OCUR) %>% 
  tally()
state_population<- irs %>%
  group_by(cve_edo) %>%
  summarize(tot00 = sum(pop2000, na.rm = TRUE),
            tot05 = sum(pop2005, na.rm = TRUE),
            tot10=sum(pop2010, na.rm=TRUE),
            tot15=sum(pop2015, na.rm=TRUE))

## Have to do this because there is no single ID (as compared to municipal data)
suicides_state_yearly<-suicides_state_yearly %>% 
  mutate(year_merge = case_when(ANIO_OCUR<2000 ~ "tot00",
                                           ANIO_OCUR>=2000 & ANIO_OCUR<=2004 ~ "tot00",
                                           ANIO_OCUR>=2005 & ANIO_OCUR<= 2009 ~ "tot05",
                                           ANIO_OCUR>=2010 & ANIO_OCUR<= 2015 ~ "tot10",
                                           ANIO_OCUR>2015 ~ "tot15"))

state_population<-melt(state_population, id=c("cve_edo"))

suicides_state_yearly <- dplyr:: left_join(suicides_state_yearly, state_population,by=c("state_ocur"="cve_edo", "year_merge"="variable"))
#rm(death_certificates)
suicides_state_yearly<-suicides_state_yearly %>% 
  mutate(rate = n/value*k)
state_average_suicide<-suicides_state_yearly%>%
  group_by(state_ocur) %>%
  summarise_at(vars(rate), funs(mean(., na.rm=TRUE)))
state_average_suicide<-state_average_suicide[which(state_average_suicide$state_ocur!= 99 & state_average_suicide$state_ocur!=33 & state_average_suicide$state_ocur!=35),]

## PLOT THE HEXBINS ####
df_mx_state<- select (df_mxstate, c(region, state_name, state_name_official, state_abbr,pop))
df_mx_state<-merge(x=df_mx_state, y=state_average_suicide, by.x='region', by.y="state_ocur")

colnames(df_mx_state)[colnames(df_mx_state)=="rate"] <- "value"

library("mxmaps")
library("viridis")
library("scales")

state_suicide_rate_plot<- mxhexbin_choropleth(df_mx_state, num_colors = 1) +
  scale_fill_gradient("Rate",low=ami_cols("green"), high = ami_cols("orange")) +
   labs(title = "Average Suicide Rate 1998-2017",
       subtitle = "Southeastern states show the higher suicide rates",
       caption = "Source: INEGI, CONAPO and Diego Valle's Blog for the hexaplot  (https://www.diegovalle.net)")+
  
  
 theme(plot.title = element_text(size = 14, family = "Karla", face='bold')) +
  theme(plot.subtitle = element_text(size=12, family = "Karla", face = "plain")) + 
    theme(text=element_text(family="Karla")) +
        theme(legend.key=element_rect(fill="white", colour="white")) +
  theme(plot.caption = element_text(family="Karla", size=7)) 
state_suicide_rate_plot


### MUNICIPAL SUICIDES ####

#load(here::here("Data/Shape_Mun/Municipios.shp"))

mun_shape <- st_read(here::here("Data/muni_2012gw/Muni_2012gw.shp"))
state_shape<- st_read(here::here("Data/state_boundaries/State.shp"))
state_shape2<- st_read(here::here("data/state_boundaries/dest_2015gw/dest_2015gw.shp"))
# path = here("death_certificates.RData")
# print(path)
# data = load(path)
suicides_municipal_yearly <-
  filter(death_certificates, non_natural_causes== 'Suicide') %>% 
  group_by(state_mun_OCUR, ANIO_OCUR) %>% 
  tally()

suicides_municipal_yearly<- merge(x = suicides_municipal_yearly, y = irs, by.x = 'state_mun_OCUR', by.y ='municipal_id' )

suicides_municipal_yearly<-  select (suicides_municipal_yearly,c(state_mun_OCUR, "ANIO_OCUR", "n", "cve_edo","state_name",  "municipal_name", "pop2000", "pop2005", "pop2010", "pop2015"))


suicides_municipal_yearly<- suicides_municipal_yearly %>% 
  mutate(rate= case_when(ANIO_OCUR<=2002 ~ n/(as.numeric(pop2000))*k,    ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ (n/as.numeric(pop2005))*k, 
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ (n/as.numeric(pop2010))*k,
                                          ANIO_OCUR>2013 ~ (n/as.numeric(pop2015))*k), na.rm = TRUE)

#rate_suicides_17 <- subset(suicides_municipal_yearly, ANIO_OCUR==2017)

municipal_average_suicide<-suicides_municipal_yearly%>%
  group_by(state_mun_OCUR, municipal_name, cve_edo, state_name) %>%
  summarise_at(vars(rate), funs(mean(., na.rm=TRUE)))

mun_shape<- mun_shape %>% 
    mutate(state_mun_OCUR= paste(CVE_ENT, CVE_MUN, sep=""))
 
mun_shape = mun_shape %>% 
    left_join(municipal_average_suicide, by = "state_mun_OCUR")  

mun_shape<- mun_shape %>%
  mutate(rate_cut = cut(mun_shape$rate, c(0,8,16,50,356))) 

municipal_suicides<-ggplot() +
  geom_sf(data=state_shape2, fill = '#00000000', size=.4) +
   geom_sf(data = mun_shape, aes(fill = rate_cut), size=.01) + 
   # scale_colour_gradient2(low=ami_cols("green"), high=ami_cols("orange"),
   #                      na.value = ami_cols("dark grey") 
   #                       ) +
  #scale_fill_gradient(name = 'Rate(#/100k)',low = ami_cols("green"), high = ami_cols('orange')) +
  #scale_colour_gradientn(colors=ami_pal("cool")(4)) +
  #scale_fill_brewer( color=ami_cols("green"), name = "Rate (#/100K)" )+
  coord_sf(datum = NA)+
  labs(title = "Municipal Average Suicide Rate 1998-2017",
       legend = "Rate (#/100K)", 
       caption = "Source: INEGI and CONAPO ") +
scale_color_manual(name = "Rate",
                     values = c("(0,16]" = ami_cols("green"),
                                  "(16,50]" = ami_cols("blue"),
                                  "(50,100]" = ami_cols("orange"),
                                   "(100,356]" = ami_cols("red") ),
                     labels = c("<= 16", "16 < rate <= 50", "100 < rate <= 356"))+
  theme_ami + 
  theme(panel.grid = element_blank()) 
   #scale_colour_manual(values = c(ami_pal("cool")(4)))

municipal_suicides
```


