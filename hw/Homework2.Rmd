---
title: "Homework 2"
author: "Aleister Montfort"
date: "1/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(ggplot2)
library(here)
library(zoo)
library(lubridate)
library(dplyr)
```

```{r, load data, include=FALSE}
here()
path = here("death_certificates.RData")
print(path)
data = load(path)
```
```{r, other data, include=FALSE}
here()
path = here("gini2010.RData")
path
load(path)
# typeof(gini2010)
file.exists(path)
path = here("gini2015.RData")
file.exists(path)
gini2015 = load(path)
path = here("irs.RData")
file.exists(path)
irs = load(path)
```
```{r, message=FALSE}
ggplot(gini2010, aes(x=gini, y=income_ratio)) + geom_point()
```


```{r, prepare data chart 1, include=FALSE}
# death_certificates <- subset(death_certificates, year_death>1997 & year_death!=9999)
# 
# ## CREATE YEAR MONTH VAR ####
death_certificates$yearmonth <- as.yearmon(paste(death_certificates$year_death, death_certificates$month_death), "%Y %m")
# # DATAFRAME WITH AGGREGATION BY TYPE OF DEATH ####
# death_certificates$yearmonth <- as.yearmon(paste(death_certificates$year_death, death_certificates$month_death), "%Y %m")
# death_certificates$counter=1 # maybe this is not necessary but for now...
# monthly_death_national <- death_certificates %>%
#   group_by(yearmonth, non_natural_causes) %>%
#   summarize(homicides = sum(counter[non_natural_causes=="homicide"]),
#             suicides = sum(counter[non_natural_causes=="suicide"]),
#             accidents = sum(counter[non_natural_causes=="accident"]),
#             war = sum(counter[non_natural_causes=="war_operations"]),
#             dn = sum(counter[non_natural_causes=="don't know"]))
death_certificates <- death_certificates%>%
    mutate(non_natural_causes = if_else(is.na(non_natural_causes), "N.A/Natural Death", non_natural_causes))

monthly_death_national <-
  death_certificates %>% 
  group_by(yearmonth, non_natural_causes) %>% 
  tally()
print.data.frame(head(monthly_death_national))

```

```{r, prepare data chart 1, include=FALSE}

##CREATE DFS for each type of death ####
total_deaths <- death_certificates %>%
                group_by(yearmonth) %>%
                summarize(total = sum(counter))
homicides<-subset(monthly_death_national[c('yearmonth','homicides','non_natural_causes')],
                  non_natural_causes=='homicide')[c('yearmonth', 'homicides')]
suicides<-subset(monthly_death_national[c('yearmonth','suicides','non_natural_causes')],
                 non_natural_causes=='suicide')[c('yearmonth', 'suicides')]
accidents<-subset(monthly_death_national[c('yearmonth','accidents', 'non_natural_causes')],
                  non_natural_causes=='accident')[c('yearmonth', 'accidents')]
war<-subset(monthly_death_national[c('yearmonth','war','non_natural_causes')],
            non_natural_causes=='war_operations')[c('yearmonth', 'war')]
dn<-subset(monthly_death_national[c('yearmonth','dn','non_natural_causes')],
           non_natural_causes=="don't know")[c('yearmonth', 'dn')]
## MERGE THEM ####
monthly_deaths<- merge(x=total_deaths, y = homicides, by.x="yearmonth", by.y="yearmonth", all.x = TRUE)
monthly_deaths<-merge(x=total_deaths, suicides, by.x="yearmonth", by.y="yearmonth", all.x = TRUE)
monthly_deaths<-merge(x=total_deaths, accidents, by.x="yearmonth", by.y="yearmonth", all.x = TRUE)
monthly_deaths<-merge(x=total_deaths, war, by.x="yearmonth", by.y="yearmonth", all.x = TRUE)
monthly_deaths<-merge(x=total_deaths, dn, by.x="yearmonth", by.y="yearmonth", all.x = TRUE)

```

```{r, adding population, include=FALSE}
monthly_deaths$year<-year(monthly_deaths$yearmonth)

## ADD POPULATION TO OBTAIN RATES
total_deaths<-
  total_deaths %>% mutate(pop_divide = case_when(year<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          year>2002 & year<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          year>2008 & year<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          year>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))
total_deaths <- subset(total_deaths, year>1997 & year!=9999)
mult<-100000

```

```{r, final_manipulation, include=FALSE}
total_deaths<-total_deaths %>% 
  mutate(natural = if_else(year>=2004, total - suicides - homicides - accidents - war - dn, 
                                     total - suicides - homicides - accidents - dn))
  total_deaths<-total_deaths %>% 
    mutate(natural_rate=natural/pop_divide*mult,
           homicide_rate = homicides/pop_divide*mult,
           suicide_rate = suicides/pop_divide*mult,
           accident_rate = accidents/pop_divide*mult,
           war_rate = war/pop_divide*mult,
           dontknow_rate = dn/pop_divide*mult)
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, graphs, warning=FALSE, message=FALSE, error=FALSE}
print(de)

```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
