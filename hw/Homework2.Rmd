---
title: "Homework 2"
author: "Aleister Montfort"
date: "1/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE, include=FALSE}
library(ggplot2)
library(here)
library(zoo)
#library(lubridate)
library(dplyr)
library(ggridges)
```

```{r, load data, include=FALSE}
here()
path = here("death_certificates.RData")
print(path)
data = load(path)
```
```{r, other data, include=FALSE}
# here()
# path_gini10 = here::here("gini2010.RData")
# load(path_gini10)
# typeof(gini2010)
# file.exists(path_gini10)
# path_gini15 = here::here("gini2015.RData")
# file.exists(path_gini15)
# gini2015 = load(path_gini15)
# pathiris = here::here("irs.RData")
# file.exists(pathiris)
# irs = load(pathiris)
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2015.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2010.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/irs.RData")

```


```{r, include=FALSE}
library(here)
path = here::here("irs.RData")
file.exists(path)
irs = load(path)

```



```{r, prepare data chart 1, include=FALSE}

death_certificates <- subset(death_certificates, year_death>1997 & year_death!=9999)
## CREATE YEAR MONTH VAR ####
death_certificates$yearmonth <- as.yearmon(paste(death_certificates$year_death, death_certificates$month_death), "%Y %m")

death_certificates <- death_certificates%>%
    mutate(non_natural_causes = if_else(is.na(non_natural_causes), "N.A/Natural Death", non_natural_causes))

monthly_death_national <-
  death_certificates %>% 
  group_by(yearmonth, ANIO_OCUR, non_natural_causes) %>% 
  tally()
print.data.frame(head(monthly_death_national))

TOTAL_monthly_death_national <-
  death_certificates %>% 
  group_by(yearmonth, ANIO_OCUR) %>% 
  tally()
print.data.frame(head(TOTAL_monthly_death_national))

```


```{r, adding population, include=FALSE, warning=FALSE}
# library(lubridate)
# monthly_death_national<- 
#   monthly_death_national %>%
#   mutate(year=year(yearmonth))

## ADD POPULATION TO OBTAIN RATES 
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2015.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/gini2010.RData")
load("~/Documents/Chicago_2018_2019/Winter 2019/Data viz/data_viz_work/irs.RData")
monthly_death_national<-
  monthly_death_national %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))

TOTAL_monthly_death_national<-
  TOTAL_monthly_death_national %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))

mult<-100000
monthly_death_national<-monthly_death_national %>% 
                        mutate(death_rate=n/pop_divide*mult)
TOTAL_monthly_death_national<-TOTAL_monthly_death_national %>% 
                        mutate(death_rate=n/pop_divide*mult)                      
```

```{r, total rate plotline, message=FALSE, echo=FALSE, warning=FALSE}
library(ggplot2)
## TOTAL ####
total_rate_plot=ggplot(TOTAL_monthly_death_national, aes(x=yearmonth, y=death_rate)) +
  geom_line()  +
  geom_line(col="blue", alpha=.6)  +
  stat_smooth(
    color = "#FC4E07", alpha=.04,
    method = "loess", se = FALSE) +
      labs(title = "Monthly Mortality Rate in Mexico 1998-2017",
       subtitle = "Total deaths rate trend shows is increasing, probably driven by the grow in the homicides-rate",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  geom_vline(xintercept =2006.917 , linetype="dotted", 
                color = "red", size=1)+ 
    geom_text(aes(x=2007.1, label="War on drugs starts", y=10), colour="red", hjust = 0) +
  theme_bw() +
  theme(axis.title.y = element_text(size=12))+
     theme(plot.title = element_text(lineheight=.8, face="bold"))
total_rate_plot
```

```{r, natural deaths plotline, message=FALSE, echo=FALSE, warning=FALSE}
## NATURAL DEATHS ####
natural_death_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("N.A/Natural Death")), aes(x=yearmonth, y=death_rate)) +
  geom_line() +ylab('Monthly Rate') +
  geom_line(col="blue", alpha=.6)  +
   labs(title = "Natural Deaths Mortality Rate in Mexico 1998-2017",
       subtitle = "Once we exclude non-natural causes, we observe that rates in deaths has also increased in Mexico",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  stat_smooth(
    color = "#FC4E07", alpha=.02,
    method = "loess", se = FALSE) +
  xlab("") +
  theme_bw()+
  theme(axis.title.y = element_text(size=12))
natural_death_plot
```

```{r, suicides plotline, message=FALSE, echo=FALSE, warning=FALSE}

## Suicides ####
suicide_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("Suicide")), aes(x=yearmonth, y=death_rate)) +
  geom_line()  +
  geom_line(col="blue", alpha=.6)  +
  # stat_smooth(
  #   color = "#FC4E07", alpha=.04,
  #   method = "loess", se = FALSE) +
 labs(title = "Suicides: Ramping up",
       subtitle = "Suicides rate have increased in the last 20 years. On average, they have doubled, whereas in\nthe rest of the world, the opposite trend persists",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  theme_bw() +
  theme(axis.title.y = element_text(size=12))
suicide_plot
```


```{r, Accidents Plotline, message=FALSE, echo=FALSE, warning=FALSE}
## Accidents ####
max_acident<-max(monthly_death_national[monthly_death_national$non_natural_causes == "Accident",]$death_rate)
accidents_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("Accident")), aes(x=yearmonth,y=death_rate))+
  geom_line() +ylab('Accidents') +
  geom_line(col="blue", alpha=.6)  +
  # stat_smooth(
  #   color = "#FC4E07", alpha=.04,
  #   method = "loess", se = FALSE) +
  labs(title = "Dwindling accidents",
       subtitle = "Accident-related deaths show a smooth decrease in the last 20 years",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  geom_vline(xintercept =2001 , linetype="dotted", 
                color = "red", size=1)+ 
  geom_text(aes(x=2001.2, label="December 2000: maximum \nmonthly rate in 20 years (4.8)", y=2.5), colour="red", hjust = 0) +
    #geom_text(aes(x=2003.9, label="Maximum monthly rate \n in 20 years: 4.8", y=3), colour="red") +
  theme_bw()+
  theme(axis.title.y = element_text(size=12))
accidents_plot
```

```{r, Homicides plotline, message=FALSE, echo=FALSE, warning=FALSE}
## Homicides ####
homicide_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("Homicide")), aes(x=yearmonth, y=death_rate)) +
  geom_line() +ylab('Monthly Rate') +
  geom_line(col="blue", alpha=.6)  +
  # stat_smooth(
  #   color = "#FC4E07", alpha=.04,
  #   method = "loess", se = FALSE) + 
  geom_vline(xintercept =2006.917 , linetype="dotted", 
                color = "red", size=1)+ 
    geom_text(aes(x=2007.0, label="War on drugs starts", y=.20), colour="red", hjust = 0) +
labs(title = "Homicides rate: the upward trend doesn't give up",
       subtitle = "After a substantive decrease between 2011-2015, homicides rate shows a sharp upward trend",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  xlab("") +
  theme_bw()+
  theme(axis.title.y = element_text(size=12))
homicide_plot
```

```{r, wat deaths plotline, message=FALSE, echo=FALSE, warning=FALSE}
## WAR DEATHS #### jun 2010
war_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("War Operations") & ANIO_OCUR>2003), aes(x=yearmonth, y=death_rate)) +
  geom_line() +ylab('Monthly Rate') +
  geom_line(col="blue", alpha=.6)  +
  stat_smooth(
    color = "#FC4E07", alpha=.04,
    method = "loess", se = FALSE) +
  geom_vline(xintercept =2010.417, linetype="dotted", 
                color = "red", size=1)+
   geom_vline(xintercept =2015.083, linetype="dotted", 
                color = "red", size=1)+ 
  geom_text(aes(x=2012.417, label="Decrease in \n homicides rate", y=.0265), colour="red") +
    labs(title = "War-operations: the costs of decreasing the homicides rate?",
       subtitle = "Deaths in this category show a greater variability and levels between 2011 and 2015, \na coincident period with the temporal drop in homicides",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  theme_bw()
war_plot
```

```{r, dont know plotlines, message=FALSE, echo=FALSE, warning=FALSE}

## DONT KNOW DEATHS####
dn_plot=ggplot(subset(monthly_death_national,non_natural_causes %in% c("Don't know")), aes(x=yearmonth, y=death_rate)) +
  geom_line() +ylab('Unknown') +
  geom_line(col="blue", alpha=.6)  +
  # stat_smooth(
  #   color = "#FC4E07", alpha=.04,
  #   method = "loess", se = FALSE) +
 geom_text(aes(x=2012.8, label="Decrease in \n homicides", y=.1), colour="red") +
  geom_vline(xintercept =2010.417, linetype="dotted", 
                color = "red", size=1)+
   geom_vline(xintercept =2015.083, linetype="dotted", 
                color = "red", size=1)+
    labs(title = "Deaths without classification: an increasing State's inability to produce vital stats",
       subtitle = "There is a significant increase in these classification of deaths, which reflects an increasing \nlack of State capacity to classify deaths",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Year", y = "Monthly Rate (per 100k)")  +
  theme_bw()+
  theme(axis.title.y = element_text(size=12))
dn_plot
```


## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r, graphs, warning=FALSE, message=FALSE, error=FALSE}


```

## Including Plots

You can also embed plots, for example:

```{r pressure, warning=FALSE, message=FALSE, error=FALSE}
causes<- death_certificates %>% select(cause_of_death,sex,school_category, age_years)

causes_male <- filter(causes, cause_of_death!= 'HOMICIDES' & cause_of_death!= 'WAR OPERATIONS' & cause_of_death!= 'OTHER ACCIDENT' & cause_of_death!= 'AIR, WATER, OTHER TRANSPORT ACC' & sex=="Male")


causes_male = causes_male %>% 
                              mutate(cause_of_death = if_else( 
                                cause_of_death=='AFTERMATH' | 
                                cause_of_death=='PERINATAL PERIOD ILLNESS' | 
                                cause_of_death=='ABNORMAL CLINIC LAB' |
                                cause_of_death=='MEDICAL ASSIST' | cause_of_death=='EYE ILLNESS'| 
                                cause_of_death=="LEGAL DRUG ABUSE"|cause_of_death=='DIGESTIVE SYSTEM', 'OTHER', cause_of_death))
causes_male = causes_male %>% 
                              mutate(cause_of_death = if_else( 
                                cause_of_death=='DRUG_USE_LEGAL', 'LEGAL DRUG ABUSE', cause_of_death))
causes_male = causes_male %>% 
                              mutate(cause_of_death = if_else( 
                                cause_of_death=='HIV', 'AIDS', cause_of_death))
causes_male = causes_male %>% 
                              mutate(cause_of_death = if_else( 
                                cause_of_death=='CONGENITAL MALF', 'CONGENITAL MALFORMATIONS', cause_of_death))
causes_male = causes_male %>% 
                              mutate(cause_of_death = if_else( 
                                cause_of_death=='OSTEOMUSCULAR CONJ', 'OSTEOMUSCULAR AND CONJUNCTIVE DISEASES', cause_of_death))


causes_normalized_age_male<- causes_male %>% 
  group_by(age_years, cause_of_death) %>% 
  tally() %>% 
group_by(age_years) %>% mutate(percent = n/sum(n)*100)

causes_normalized_age_male$ordered_vars <- factor(causes_normalized_age_male$cause_of_death, levels=c("OTHER", "CONGENITAL MALFORMATIONS","GENITOURINARY","OSTEOMUSCULAR AND CONJUNCTIVE DISEASES","CIRCULATORY SYSTEM", "INFECTION NO HIV", "AIDS", "MENTAL ILLNESS" , "CANCER", "NERVOUS SYSTEM ILLNESS",  "RESPIRATORY SYSTEM", "SUICIDES" ))
size_parameter<-2.5
causesplot<-ggplot(causes_normalized_age_male, aes(x=age_years, y=percent, fill=cause_of_death)) + 
    geom_area( size=.05, alpha=.7, color='black' , show.legend = FALSE) +
    geom_text(aes(x=25, label="Other", y=98), colour="white", size=size_parameter) +
    geom_text(aes(x=85, label="Congenital Malformations", y=90), colour="white", size=size_parameter) +
    geom_text(aes(x=85, label="Genitourinary", y=80), colour="white", size=size_parameter) +
    geom_text(aes(x=75, label="Osteomuscular and Conjuctive Diseases", y=74), colour="white", size=size_parameter) +
    geom_text(aes(x=85, label="Circulatory System", y=68), colour="white", size=size_parameter) +
    geom_text(aes(x=85, label="Infections", y=58), colour="white", size=size_parameter) +
    geom_text(aes(x=34, label="AIDS", y=48), colour="white", size=size_parameter) +
    geom_text(aes(x=58, label="Mental Illness", y=44), colour="white", size=size_parameter) +
    geom_text(aes(x=30, label="Cancer", y=30), colour="white", size=size_parameter) +
    geom_text(aes(x=75, label="Nervous System", y=8), colour="white", size=size_parameter) +
    geom_text(aes(x=75, label="Respiratory System", y=3), colour="white", size=size_parameter) +
    geom_text(aes(x=23, label="Suicides", y=3), colour="white", size=size_parameter) +
  labs(title = "Principal Male Mortality Causes in Mexico 1998-2017",
       caption = "Source: National Institute of Statistics and Geography (INEGI)", 
       x = "Age", y = "Percent")
```

```{r, warning=FALSE, message=FALSE, error=FALSE}
####### INEQUALITY AND POPULATION #####
# First I want to create average change in suicide rate
library(lubridate)
library(stringi)

suicides_municipal_month <-
  filter(death_certificates, non_natural_causes== 'Suicide') %>% 
  group_by(state_mun_OCUR, ANIO_OCUR) %>% 
  tally()

suicides_municipal_month %>% mutate(pop_divide = case_when(ANIO_OCUR<=2002 ~ sum(as.numeric(irs$pop2000), na.rm = TRUE),
                                          ANIO_OCUR>2002 & ANIO_OCUR<=2008 ~ sum(as.numeric(irs$pop2005), na.rm = TRUE),
                                          ANIO_OCUR>2008 & ANIO_OCUR<= 2013 ~ sum(as.numeric(irs$pop2010), na.rm=TRUE),
                                          ANIO_OCUR>2013 ~ sum(as.numeric(irs$pop2015), na.rm=TRUE)))
pop15<-irs[,c('pop2015', 'municipal_id')]

suicides_municipal_month<- merge(x = suicides_municipal_month, y = pop15, by.x = 'state_mun_OCUR', by.y ='municipal_id' )
suicides_15<-(subset(suicides_municipal_month, suicides_municipal_month$ANIO_OCUR==2015))
suicides_15<- suicides_15 %>%
  mutate(rate_suic_15 = n/pop2015*100000)
suicides_municipal_month<-suicides_municipal_month%>%
  mutate(diff_perc_rate = (((n/pop2015)  - lag((n/pop2015)))/lag((n/pop2015))))

# suicides_municipal_month<- suicides_municipal_month %>%
#   mutate(diff_perc_rate = ((n  - lag(n))/lag(n)))
# 
# irs$municipal_id
# 
# ###
# 
# suicides_15<- merge(x = subset(suicides_municipal_month, suicides_municipal_month$), y = pop15, by.x = 'state_mun_OCUR', by.y ='municipal_id' )

mean_suicide<-suicides_municipal_month  %>%
  group_by(state_mun_OCUR) %>%
  summarise_at(vars(diff_perc_rate), funs(mean(., na.rm=TRUE)))

mean_suicide <- merge(x = mean_suicide, y = irs, by.x = 'state_mun_OCUR', by.y ='municipal_id' )
mean_suicide <- merge(x = mean_suicide, y = gini2015, by.x = 'state_mun_OCUR', by.y ='id_municipal_gini' )
mean_suicide <- merge(x=mean_suicide, y = suicides_15, by.x='state_mun_OCUR', by.y = 'state_mun_OCUR')
mean_suicide<-mean_suicide  %>%
  mutate(income_ratio=as.numeric(income_ratio))
mean_suicide<-mean_suicide  %>%
  mutate(rank15=as.numeric(rank15))

suicides_rate_plot <- ggplot(subset(mean_suicide, mean_suicide$pop2015.x<100000 & mean_suicide$rate_suic_15<100), aes(x=pop2015.x, y=diff_perc_rate))+  # rate_suic_15
 geom_hex(bins = 30, alpha=.95) + 
  
  ggtitle("Smaller and Rural Municipalities have the largest \nsuicides rates in the country")+
  labs( subtitle = "(Rate of Suicides per 100K inhabitants)",
      caption="Source: INEGI and CONAPO,Sample limited to n\ population<100,000 and suicide rate<100", x = "Population", y = "Annual Rate (per 100k)")

suicides_ratechange_plot <- ggplot(mean_suicide, aes(x=pop2015.x, y=rate_suic_15))+ geom_hex(bins = 20, alpha=.95)+
  ggtitle("Smaller and Rural Municipalities also show the largest rate of \n growth in the last 20 years")+
  labs( subtitle = "Average rate of growth 1999-2017",
      caption="Source: INEGI and CONAPO" ,x = "Population", y = "Annual Rate (per 100k)")



# suicides_municipal_month <- merge(x = suicides_municipal_month, y = gini2015, by.x = 'state_mun_OCUR', by.y ='id_municipal_gini' )
# # mun_suicides2015 <- merge(x = subset(suicides_municipal_month, ANIO_OCUR==2015), y = mean_suicide, by.x = 'state_mun_OCUR', by.y ='state_mun_OCUR' )
# 
# suicides_municipal_month<- merge(x = suicides_municipal_month, y = irs, by.x = 'state_mun_OCUR', by.y ='municipal_id' )
# suicides_municipal_month$
# suicides_municipal_month<-suicides_municipal_month  %>%
#   mutate(gini=as.numeric(gini))
# 
# suicides_municipal_month<-suicides_municipal_month  %>%
#   mutate(gini=as.numeric(income_ratio))
# 
# # final_mun_gini<-final_mun_gini  %>%
# #   mutate(gini=as.numeric(gini))
# ## GGPLOT!
# head(final_mun_gini15)
# final_mun_gini15<-final_mun_gini15  %>%
#   mutate(one_plus_rate_suic= 1 + n/pop2015*100000)
# 
# 
# # breaks = c(seq(0, .6, by=0.1))
# # labels = as.character(breaks)
# 
# scaleFUN <- function(x) sprintf("%.2f", x)
# inequality_plot <- ggplot(suicides_municipal_month, aes(x=diff_perc_rate, y=gini))+ # colour = irs15, size=pop2015 
#  geom_point() 
# +
#   
#  scale_y_continuous(trans='log',name ="Log of 1+ suicide rate (log)", labels=scaleFUN) 
#  
#  +
#    # scale_x_continuous(trans='log',name ="log gini", labels=scaleFUN) +
# 
#   stat_smooth(color = "#FC4E07", alpha=.04,method = "loess", se=TRUE) +
#    scale_size_continuous(name = "Density") +
#   labs(color = "Marginalization \n Index\n(green=richer)") +
#   scale_color_gradientn(colours = terrain.colors(7))+
#   ggtitle("Suicides Rate and Inequality in Municipalities")+
#   labs(subtitle="Average Annual Change, Gini Index and Marginalization", 
#       caption="Source: INEGI") 


  

  
  


```

```{r, warning=FALSE, message=FALSE, error=FALSE}
library(ggridges)
suicides_national<- death_certificates %>% select(non_natural_causes,sex,school_category, age_years, year_death)

suicides_male <- filter(suicides_national, non_natural_causes=="Suicide" & sex=="Male")
suicides_male<-suicides_male  %>%
  mutate(year_death=as.character(year_death))

suicides_female <- filter(suicides_national, non_natural_causes=="Suicide" & sex=="Female")
suicides_female<-suicides_female  %>%
  mutate(year_death=as.character(year_death))

mean_age <- suicides_male %>%
    select(age_years, year_death) %>%
    group_by(year_death) %>%
    summarize(xbar = round(mean(age_years, na.rm = TRUE), 0))

## I copied the code from https://socviz.co/refineplots.html 
plot_ages_male <- ggplot(data = suicides_male,
            mapping = aes(x = age_years, y = factor((year_death)),
                                     ordered = TRUE))+
  geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 1.5) +
    scale_x_continuous(breaks = c(15,25,35, 50, 65, 80)) +
    scale_y_discrete(expand = c(0.01, 0)) + 
    ### NEED TO ADD MEAN geom_vline(data = suicides_male, aes(xintercept = grp.mean), linetype = "dashed")
    labs(x = "Age", y = NULL,
         title = "Age Distribution of\n Male Suicide Cases in Mexico 1998-2017") +
    theme_ridges() +
    theme(title = element_text(size = 16, face = "bold")) 

plot_ages_female <- ggplot(data = suicides_female,
            mapping = aes(x = age_years, y = factor((year_death)),
                                     ordered = TRUE))+
  geom_density_ridges(alpha = 0.6, fill = "lightblue", scale = 1.5) +
    scale_x_continuous(breaks = c(15,25,35, 50, 65, 80)) +
    scale_y_discrete(expand = c(0.01, 0)) + 
    ### NEED TO ADD MEAN geom_vline(data = suicides_male, aes(xintercept = grp.mean), linetype = "dashed")
    labs(x = "Age", y = NULL,
         title = "Age Distribution of\n Female Suicide Cases in Mexico 1998-2017") +
    theme_ridges() +
    theme(title = element_text(size = 16, face = "bold")) 
    # geom_vline(data = mean_age, aes(xintercept = xbar), color = "red", size = 0.5)
```


